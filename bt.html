<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth GPS Olvasó - PX1122R támogatással</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0d3b66 0%, #1a5f7a 100%);
            color: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex: 1;
            min-width: 300px;
        }
        
        .card-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #4ecdc4;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            display: inline-block;
            background: linear-gradient(to right, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: linear-gradient(to right, #ff6b6b, #ee5a52);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #6c757d, #5a6268);
        }
        
        .btn-warning {
            background: linear-gradient(to right, #ffc107, #e0a800);
        }
        
        .btn-success {
            background: linear-gradient(to right, #28a745, #218838);
        }
        
        .data-display {
            margin-top: 20px;
        }
        
        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-label {
            font-weight: 600;
            color: #a5d8ff;
        }
        
        .data-value {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #ffd166;
        }
        
        .coordinates {
            font-size: 1.3rem;
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            background-color: rgba(0, 0, 0, 0.2);
        }
        
        .status.connected {
            background-color: rgba(76, 175, 80, 0.2);
            color: #81c784;
        }
        
        .status.disconnected {
            background-color: rgba(244, 67, 54, 0.2);
            color: #ef9a9a;
        }
        
        .status.scanning {
            background-color: rgba(33, 150, 243, 0.2);
            color: #90caf9;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .instructions {
            margin-top: 30px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #4ecdc4;
        }
        
        .device-list {
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 10px;
        }
        
        .device-item {
            padding: 10px;
            margin: 5px 0;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .device-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .device-item.selected {
            background-color: rgba(78, 205, 196, 0.2);
            border-left: 3px solid #4ecdc4;
        }
        
        .hex-view {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-title {
            color: #4ecdc4;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .debug-toggle {
            background: none;
            border: none;
            color: #ffd166;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .px1122-info {
            background-color: rgba(255, 215, 102, 0.1);
            border-left: 4px solid #ffd166;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .card {
                min-width: 100%;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-satellite"></i> Bluetooth GPS Olvasó</h1>
            <p class="subtitle">PX1122R GPS modul támogatással. Különleges karakterkódolású eszközök kezelése.</p>
        </header>
        
        <div class="status disconnected" id="connectionStatus">
            <i class="fas fa-plug"></i> Nincs csatlakoztatva Bluetooth eszköz
        </div>
        
        <div class="main-content">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-bluetooth"></i> Bluetooth Kapcsolat</h2>
                
                <div class="px1122-info">
                    <h3><i class="fas fa-microchip"></i> PX1122R GPS Modul</h3>
                    <p>Az eszköz neve hibásan jelenhet meg a speciális karakterkódolás miatt. A modul általában NMEA 0183 szabványú adatokat küld.</p>
                </div>
                
                <div class="data-display">
                    <div class="data-item">
                        <span class="data-label">Eszköz neve:</span>
                        <span class="data-value" id="deviceName">-</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Eszköz ID:</span>
                        <span class="data-value" id="deviceId">-</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Kapcsolat állapota:</span>
                        <span class="data-value" id="deviceStatus">Nem csatlakoztatva</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Utolsó frissítés:</span>
                        <span class="data-value" id="lastUpdate">-</span>
                    </div>
                </div>
                
                <div class="device-list" id="deviceList">
                    <!-- Eszközök listája jelenik meg itt -->
                </div>
                
                <button class="btn" id="scanBtn">
                    <i class="fas fa-search"></i> Bluetooth eszközök keresése
                </button>
                <button class="btn btn-success" id="scanPx1122Btn">
                    <i class="fas fa-satellite-dish"></i> PX1122R modul keresése
                </button>
                <button class="btn btn-secondary" id="disconnectBtn" disabled>
                    <i class="fas fa-ban"></i> Kapcsolat bontása
                </button>
                <button class="btn btn-warning" id="simulateBtn">
                    <i class="fas fa-location-dot"></i> Szimulált GPS adatok
                </button>
                
                <div class="debug-info" id="debugInfo" style="display: none;">
                    <div class="debug-title">
                        <span>Debug információk</span>
                        <button class="debug-toggle" onclick="toggleDebugInfo()">[Bezárás]</button>
                    </div>
                    <div id="debugContent"></div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title"><i class="fas fa-map-marked-alt"></i> GPS Adatok</h2>
                <div class="coordinates" id="coordinates">
                    0.0000° N, 0.0000° E
                </div>
                
                <div class="data-display">
                    <div class="data-item">
                        <span class="data-label">Szélesség:</span>
                        <span class="data-value" id="latitude">-</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Hosszúság:</span>
                        <span class="data-value" id="longitude">-</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Magasság:</span>
                        <span class="data-value" id="altitude">-</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Sebesség:</span>
                        <span class="data-value" id="speed">-</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Pontosság:</span>
                        <span class="data-value" id="accuracy">-</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Műholdak:</span>
                        <span class="data-value" id="satellites">-</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Idő:</span>
                        <span class="data-value" id="timestamp">-</span>
                    </div>
                </div>
                
                <div class="data-display" style="margin-top: 20px;">
                    <div class="data-item">
                        <span class="data-label">NMEA üzenet:</span>
                        <span class="data-value" id="nmeaMessage">-</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> PX1122R GPS modul konfiguráció</h3>
            
            <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 15px;">
                <div style="flex: 1; min-width: 250px;">
                    <h4><i class="fas fa-cog"></i> Bluetooth beállítások</h4>
                    <ul style="padding-left: 20px;">
                        <li>Eszköz neve: PX1122R-EVB (vagy hasonló)</li>
                        <li>Bluetooth verzió: 2.1+EDR vagy 4.0</li>
                        <li>Adatátvitel: SPP (Serial Port Profile)</li>
                        <li>Baud rate: 9600 (alapértelmezett)</li>
                    </ul>
                </div>
                
                <div style="flex: 1; min-width: 250px;">
                    <h4><i class="fas fa-satellite"></i> GPS konfiguráció</h4>
                    <ul style="padding-left: 20px;">
                        <li>Formátum: NMEA 0183</li>
                        <li>Üzenetek: GGA, RMC, GSA, GSV</li>
                        <li>Frissítési ráta: 1Hz (alapértelmezett)</li>
                        <li>Műholdrendszer: GPS, GLONASS</li>
                    </ul>
                </div>
            </div>
            
            <h4 style="margin-top: 20px;"><i class="fas fa-question-circle"></i> Gyakori problémák és megoldások</h4>
            <ol style="padding-left: 20px; margin-top: 10px;">
                <li><strong>Hibás eszköznév:</strong> A PX1122R modul nem szabványos karakterkódolást használhat. Próbáld ki a "PX1122R modul keresése" gombot.</li>
                <li><strong>Nem található eszköz:</strong> Ellenőrizd, hogy a modul látható módban van-e (pairing mód).</li>
                <li><strong>Nincs adat:</strong> A modulnak szabad ég alatt kell lennie műholdjelek fogadásához.</li>
                <li><strong>Kapcsolódási hiba:</strong> Próbáld meg újraindítani a modult és/vagy a böngészőt.</li>
            </ol>
            
            <div style="background-color: rgba(255, 107, 107, 0.1); padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #ff6b6b;">
                <h4><i class="fas fa-exclamation-triangle"></i> Fontos megjegyzések</h4>
                <p>A Web Bluetooth API korlátozottan támogatja a SPP (Serial Port Profile) profilokat. A PX1122R modul valószínűleg ezt a profilt használja, ami nem minden böngészőben működik megfelelően. Ha nem sikerül csatlakozni, próbáld meg a Chrome böngészőt.</p>
            </div>
        </div>
        
        <footer>
            <p>Bluetooth GPS Olvasó &copy; 2023 | PX1122R GPS modul támogatással</p>
            <p>Ez egy demonstrációs alkalmazás a Web Bluetooth API teszteléséhez.</p>
        </footer>
    </div>

    <script>
        // DOM elemek
        const scanBtn = document.getElementById('scanBtn');
        const scanPx1122Btn = document.getElementById('scanPx1122Btn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const simulateBtn = document.getElementById('simulateBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const deviceList = document.getElementById('deviceList');
        const deviceName = document.getElementById('deviceName');
        const deviceId = document.getElementById('deviceId');
        const deviceStatus = document.getElementById('deviceStatus');
        const lastUpdate = document.getElementById('lastUpdate');
        const coordinates = document.getElementById('coordinates');
        const latitude = document.getElementById('latitude');
        const longitude = document.getElementById('longitude');
        const altitude = document.getElementById('altitude');
        const speed = document.getElementById('speed');
        const accuracy = document.getElementById('accuracy');
        const satellites = document.getElementById('satellites');
        const timestamp = document.getElementById('timestamp');
        const nmeaMessage = document.getElementById('nmeaMessage');
        const debugInfo = document.getElementById('debugInfo');
        const debugContent = document.getElementById('debugContent');
        
        // Web Bluetooth változók
        let bluetoothDevice = null;
        let gattServer = null;
        let isConnected = false;
        let simulationInterval = null;
        let discoveredDevices = [];
        let gpsCharacteristic = null;
        let debugLog = [];
        
        // Debug információk mutatása/elrejtése
        function toggleDebugInfo() {
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }
        
        // Debug információk hozzáadása
        function addDebugInfo(message, data = null) {
            const timestamp = new Date().toLocaleTimeString('hu-HU');
            const logEntry = {
                time: timestamp,
                message: message,
                data: data
            };
            
            debugLog.push(logEntry);
            
            // Csak az utolsó 10 bejegyzést tartjuk meg
            if (debugLog.length > 10) {
                debugLog.shift();
            }
            
            // Debug információk frissítése
            updateDebugDisplay();
        }
        
        // Debug információk megjelenítése
        function updateDebugDisplay() {
            debugContent.innerHTML = debugLog.map(entry => {
                let dataStr = '';
                if (entry.data) {
                    if (typeof entry.data === 'object') {
                        dataStr = JSON.stringify(entry.data, null, 2);
                    } else {
                        dataStr = entry.data.toString();
                    }
                }
                
                return `<div style="margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                    <div style="color: #4ecdc4;">[${entry.time}] ${entry.message}</div>
                    ${dataStr ? `<div style="color: #ffd166; margin-top: 5px; font-size: 0.8rem;">${dataStr}</div>` : ''}
                </div>`;
            }).join('');
        }
        
        // Karakterlánc tisztítása (speciális PX1122R probléma kezelése)
        function cleanDeviceName(name) {
            if (!name) return 'Ismeretlen eszköz';
            
            // Hex dump, ha szükséges
            addDebugInfo('Eszköznév nyers adatok:', {
                nyers: name,
                hossz: name.length,
                karakterek: Array.from(name).map(c => c.charCodeAt(0).toString(16))
            });
            
            // Eltávolítjuk a nem nyomtatható karaktereket
            let cleaned = name.replace(/[^\x20-\x7E]/g, '');
            
            // Ha üres maradt, próbáljuk meg máshogy dekódolni
            if (cleaned.trim() === '') {
                // Próbáljuk UTF-8 dekódolást
                try {
                    const encoder = new TextEncoder();
                    const decoder = new TextDecoder('utf-8');
                    const bytes = encoder.encode(name);
                    cleaned = decoder.decode(bytes);
                    cleaned = cleaned.replace(/[^\x20-\x7E]/g, '');
                } catch (e) {
                    cleaned = 'PX1122R GPS Modul';
                }
            }
            
            // Ha még mindig üres, adjunk neki egy alapértelmezett nevet
            if (cleaned.trim() === '') {
                cleaned = 'PX1122R GPS Modul';
            }
            
            return cleaned;
        }
        
        // Eszközök listájának frissítése
        function updateDeviceList(devices) {
            deviceList.innerHTML = '';
            
            if (devices.length === 0) {
                deviceList.innerHTML = '<p style="text-align: center; padding: 20px;">Nincsenek felfedezett eszközök</p>';
                return;
            }
            
            devices.forEach(device => {
                const deviceElement = document.createElement('div');
                deviceElement.className = 'device-item';
                
                const displayName = cleanDeviceName(device.name);
                
                deviceElement.innerHTML = `
                    <strong>${displayName}</strong>
                    <div style="font-size: 0.8rem; margin-top: 5px;">
                        ${device.id ? `ID: ${device.id.substring(0, 12)}...` : ''}
                    </div>
                    ${device.name !== displayName ? 
                        `<div class="hex-view">Eredeti név: "${device.name}"</div>` : 
                        ''}
                `;
                
                deviceElement.addEventListener('click', async () => {
                    // Eltávolítjuk a korábbi kijelölést
                    document.querySelectorAll('.device-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // Kijelöljük az aktuálisat
                    deviceElement.classList.add('selected');
                    
                    // Csatlakozás az eszközhöz
                    await connectToDevice(device);
                });
                
                deviceList.appendChild(deviceElement);
            });
        }
        
        // GPS adatok frissítése a felületen
        function updateGPSData(lat, lon, alt, spd, acc, sat, nmea = null) {
            // Koordináták formázása
            const latDirection = lat >= 0 ? 'É' : 'D';
            const lonDirection = lon >= 0 ? 'K' : 'Ny';
            const latAbs = Math.abs(lat).toFixed(4);
            const lonAbs = Math.abs(lon).toFixed(4);
            
            // Frissítés a felületen
            coordinates.textContent = `${latAbs}° ${latDirection}, ${lonAbs}° ${lonDirection}`;
            latitude.textContent = `${lat.toFixed(6)}°`;
            longitude.textContent = `${lon.toFixed(6)}°`;
            altitude.textContent = alt !== null ? `${alt.toFixed(1)} m` : '-';
            speed.textContent = spd !== null ? `${(spd * 3.6).toFixed(1)} km/h` : '-';
            accuracy.textContent = acc !== null ? `${acc.toFixed(1)} m` : '-';
            satellites.textContent = sat !== null ? sat : '-';
            
            // NMEA üzenet
            if (nmea) {
                nmeaMessage.textContent = nmea.length > 30 ? nmea.substring(0, 30) + '...' : nmea;
            }
            
            // Időbélyeg
            const now = new Date();
            timestamp.textContent = now.toLocaleTimeString('hu-HU');
            lastUpdate.textContent = now.toLocaleTimeString('hu-HU');
        }
        
        // Kapcsolat állapotának frissítése
        function updateConnectionStatus(connected, device = null) {
            isConnected = connected;
            
            if (connected) {
                connectionStatus.className = 'status connected';
                const displayName = device ? cleanDeviceName(device.name) : 'Bluetooth eszköz';
                connectionStatus.innerHTML = `<i class="fas fa-link"></i> Csatlakozva: ${displayName}`;
                scanBtn.disabled = true;
                scanPx1122Btn.disabled = true;
                disconnectBtn.disabled = false;
                deviceStatus.textContent = 'Csatlakozva';
                
                if (device) {
                    deviceName.textContent = displayName;
                    deviceId.textContent = device.id ? device.id.substring(0, 16) + '...' : '-';
                }
            } else {
                connectionStatus.className = 'status disconnected';
                connectionStatus.innerHTML = '<i class="fas fa-unlink"></i> Nincs csatlakoztatva Bluetooth eszköz';
                scanBtn.disabled = false;
                scanPx1122Btn.disabled = false;
                disconnectBtn.disabled = true;
                deviceStatus.textContent = 'Nem csatlakoztatva';
                deviceName.textContent = '-';
                deviceId.textContent = '-';
                
                // GPS adatok visszaállítása alapértékekre
                if (!simulationInterval) {
                    resetGPSData();
                }
            }
        }
        
        // GPS adatok visszaállítása
        function resetGPSData() {
            coordinates.textContent = '0.0000° N, 0.0000° E';
            latitude.textContent = '-';
            longitude.textContent = '-';
            altitude.textContent = '-';
            speed.textContent = '-';
            accuracy.textContent = '-';
            satellites.textContent = '-';
            timestamp.textContent = '-';
            lastUpdate.textContent = '-';
            nmeaMessage.textContent = '-';
        }
        
        // Bluetooth eszköz csatlakoztatása
        async function connectToDevice(device) {
            if (!device) return;
            
            try {
                connectionStatus.className = 'status scanning';
                connectionStatus.innerHTML = '<i class="fas fa-sync fa-spin"></i> Kapcsolódás az eszközhöz...';
                
                addDebugInfo('Kapcsolódás eszközhöz:', {
                    név: device.name,
                    id: device.id,
                    típus: device.constructor.name
                });
                
                // Ha a device egy valós BluetoothDevice objektum (nem szimulált)
                if (device.gatt) {
                    bluetoothDevice = device;
                    
                    // Eseménykezelő a kapcsolat megszakadásához
                    bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                    
                    // Kapcsolódás a GATT szerverhez
                    gattServer = await bluetoothDevice.gatt.connect();
                    
                    addDebugInfo('GATT szerverhez kapcsolódva');
                    
                    // Próbáljuk megkeresni a szolgáltatásokat
                    try {
                        const services = await gattServer.getPrimaryServices();
                        addDebugInfo(`Megtalált szolgáltatások: ${services.length} db`);
                        
                        // Logoljuk a szolgáltatásokat
                        for (const service of services) {
                            addDebugInfo(`Szolgáltatás: ${service.uuid}`);
                        }
                        
                        // Próbáljuk megtalálni a Serial Port szolgáltatást (PX1122R valószínűleg ezt használja)
                        // Standard Serial Port Service UUID: 00001101-0000-1000-8000-00805f9b34fb
                        const serialServiceUUID = '00001101-0000-1000-8000-00805f9b34fb';
                        
                        let serialService = null;
                        for (const service of services) {
                            if (service.uuid === serialServiceUUID || 
                                service.uuid.replace(/-/g, '').toLowerCase() === serialServiceUUID.replace(/-/g, '').toLowerCase()) {
                                serialService = service;
                                break;
                            }
                        }
                        
                        if (serialService) {
                            addDebugInfo('Serial Port szolgáltatás megtalálva');
                            
                            // Karakterisztikák lekérése
                            const characteristics = await serialService.getCharacteristics();
                            addDebugInfo(`Karakterisztikák: ${characteristics.length} db`);
                            
                            for (const char of characteristics) {
                                addDebugInfo(`Karakterisztika: ${char.uuid}, tulajdonságok: ${char.properties}`);
                                
                                // Ha van notify tulajdonság, feliratkozunk rá
                                if (char.properties.notify) {
                                    gpsCharacteristic = char;
                                    
                                    // Feliratkozás az értesítésekre
                                    await gpsCharacteristic.startNotifications();
                                    gpsCharacteristic.addEventListener('characteristicvaluechanged', handleGPSData);
                                    
                                    addDebugInfo('Feliratkozva a GPS adatokra');
                                    break;
                                }
                            }
                        } else {
                            addDebugInfo('Serial Port szolgáltatás nem található, szimulált adatokat használunk');
                        }
                        
                    } catch (serviceError) {
                        addDebugInfo('Hiba a szolgáltatások olvasásakor:', serviceError.message);
                    }
                    
                } else {
                    // Szimulált eszköz
                    bluetoothDevice = device;
                    addDebugInfo('Szimulált eszközhöz kapcsolódva');
                }
                
                updateConnectionStatus(true, bluetoothDevice);
                
                // Szimulált GPS adatok indítása (ha nem találtunk valódi GPS karakterisztikát)
                if (!gpsCharacteristic) {
                    startGPSSimulation();
                }
                
            } catch (error) {
                console.error('Hiba a csatlakozás során:', error);
                addDebugInfo('Hiba a kapcsolódás során:', error.message);
                
                connectionStatus.className = 'status disconnected';
                connectionStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> Hiba: ${error.message}`;
                updateConnectionStatus(false);
            }
        }
        
        // GPS adatok kezelése (ha valódi adatok érkeznek)
        function handleGPSData(event) {
            const value = event.target.value;
            
            // Adatok dekódolása
            const decoder = new TextDecoder();
            const dataString = decoder.decode(value);
            
            addDebugInfo('GPS adat érkezett:', dataString);
            
            // NMEA üzenet feldolgozása (egyszerűsített)
            // Valós implementációban itt kellene parse-olni a GGA, RMC stb. üzeneteket
            if (dataString.includes('$GPGGA') || dataString.includes('$GPRMC')) {
                nmeaMessage.textContent = dataString.trim();
                
                // Szimulált adatok frissítése (valós implementációban itt a tényleges NMEA feldolgozás lenne)
                const now = new Date();
                const lat = 47.4979 + (Math.random() - 0.5) * 0.01;
                const lon = 19.0402 + (Math.random() - 0.5) * 0.01;
                
                updateGPSData(
                    lat, lon,
                    120 + Math.random() * 30,
                    Math.random() * 5,
                    5 + Math.random() * 10,
                    5 + Math.floor(Math.random() * 8),
                    dataString.trim()
                );
            }
        }
        
        // PX1122R specifikus keresés
        async function scanForPx1122() {
            if (!checkBluetoothSupport()) return;
            
            try {
                connectionStatus.className = 'status scanning';
                connectionStatus.innerHTML = '<i class="fas fa-satellite-dish"></i> PX1122R modul keresése...';
                
                addDebugInfo('PX1122R modul keresése indítva');
                
                // Különböző UUID próbálkozások a PX1122R-hez
                const options = {
                    acceptAllDevices: true,
                    optionalServices: [
                        '00001101-0000-1000-8000-00805f9b34fb', // Standard Serial Port
                        'battery_service',
                        'device_information'
                    ]
                };
                
                // Bluetooth eszköz kiválasztása
                bluetoothDevice = await navigator.bluetooth.requestDevice(options);
                
                if (bluetoothDevice) {
                    addDebugInfo('PX1122R típusú eszköz kiválasztva:', {
                        név: bluetoothDevice.name,
                        id: bluetoothDevice.id
                    });
                    
                    discoveredDevices.push(bluetoothDevice);
                    updateDeviceList(discoveredDevices);
                    
                    // Kapcsolódás az eszközhöz
                    await connectToDevice(bluetoothDevice);
                }
                
            } catch (error) {
                console.error('Hiba a PX1122R keresése során:', error);
                addDebugInfo('Hiba a PX1122R keresése során:', error.message);
                
                if (error.name === 'NotFoundError') {
                    connectionStatus.className = 'status disconnected';
                    connectionStatus.innerHTML = '<i class="fas fa-times-circle"></i> Nincs PX1122R eszköz kiválasztva';
                } else {
                    connectionStatus.className = 'status disconnected';
                    connectionStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> Hiba: ${error.message}`;
                }
                
                updateConnectionStatus(false);
            }
        }
        
        // Általános Bluetooth eszközök keresése
        async function scanForDevices() {
            if (!checkBluetoothSupport()) return;
            
            try {
                connectionStatus.className = 'status scanning';
                connectionStatus.innerHTML = '<i class="fas fa-search"></i> Bluetooth eszközök keresése...';
                
                addDebugInfo('Általános Bluetooth keresés indítva');
                
                const options = {
                    acceptAllDevices: true,
                    optionalServices: ['battery_service', 'device_information']
                };
                
                bluetoothDevice = await navigator.bluetooth.requestDevice(options);
                
                if (bluetoothDevice) {
                    addDebugInfo('Bluetooth eszköz kiválasztva:', {
                        név: bluetoothDevice.name,
                        id: bluetoothDevice.id
                    });
                    
                    discoveredDevices.push(bluetoothDevice);
                    updateDeviceList(discoveredDevices);
                    
                    await connectToDevice(bluetoothDevice);
                }
                
            } catch (error) {
                console.error('Hiba az eszközök keresése során:', error);
                addDebugInfo('Hiba az eszközök keresése során:', error.message);
                
                if (error.name === 'NotFoundError') {
                    connectionStatus.className = 'status disconnected';
                    connectionStatus.innerHTML = '<i class="fas fa-times-circle"></i> Nincs Bluetooth eszköz kiválasztva';
                } else {
                    connectionStatus.className = 'status disconnected';
                    connectionStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> Hiba: ${error.message}`;
                }
                
                updateConnectionStatus(false);
            }
        }
        
        // Kapcsolat bontása
        function disconnectFromDevice() {
            if (bluetoothDevice && bluetoothDevice.gatt) {
                if (bluetoothDevice.gatt.connected) {
                    bluetoothDevice.gatt.disconnect();
                    addDebugInfo('Kapcsolat bontva');
                }
            }
            
            if (gpsCharacteristic) {
                try {
                    gpsCharacteristic.stopNotifications();
                    gpsCharacteristic.removeEventListener('characteristicvaluechanged', handleGPSData);
                } catch (e) {
                    // Figyelmen kívül hagyjuk, ha nem lehet leállítani
                }
                gpsCharacteristic = null;
            }
            
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            
            bluetoothDevice = null;
            gattServer = null;
            
            updateConnectionStatus(false);
            addDebugInfo('Eszköz leválasztva');
        }
        
        // Szimulált GPS adatok indítása
        function startGPSSimulation() {
            if (simulationInterval) {
                clearInterval(simulationInterval);
            }
            
            // Budapest kezdő koordinátái
            let lat = 47.4979;
            let lon = 19.0402;
            
            // Szimulált GPS adatok frissítése
            simulationInterval = setInterval(() => {
                // Véletlen elmozdulás a jelenlegi pozícióhoz képest
                lat += (Math.random() - 0.5) * 0.001;
                lon += (Math.random() - 0.5) * 0.001;
                
                // További GPS adatok szimulálása
                const alt = 100 + Math.random() * 50;
                const spd = Math.random() * 5;
                const acc = 5 + Math.random() * 10;
                const sat = 5 + Math.floor(Math.random() * 8);
                
                // NMEA szimuláció
                const nmea = `$GPGGA,${new Date().toUTCString().substr(11, 8)},${Math.abs(lat).toFixed(4)},${lat >= 0 ? 'N' : 'S'},${Math.abs(lon).toFixed(4)},${lon >= 0 ? 'E' : 'W'},1,${sat},${acc.toFixed(1)},${alt.toFixed(1)},M,,M,,*00`;
                
                updateGPSData(lat, lon, alt, spd, acc, sat, nmea);
            }, 2000);
            
            // Azonnali frissítés
            const nmea = `$GPGGA,${new Date().toUTCString().substr(11, 8)},${Math.abs(lat).toFixed(4)},N,${Math.abs(lon).toFixed(4)},E,1,8,5.0,120.0,M,,M,,*00`;
            updateGPSData(lat, lon, 120, 2.5, 5.0, 8, nmea);
            
            addDebugInfo('Szimulált GPS adatok indítva');
        }
        
        // Szimulált GPS adatok indítása (teszteléshez)
        function startSimulationOnly() {
            if (simulationInterval) {
                clearInterval(simulationInterval);
            }
            
            const simulatedDevice = {
                name: 'Szimulált PX1122R GPS',
                id: 'demo-px1122r-simulated'
            };
            
            updateConnectionStatus(true, simulatedDevice);
            startGPSSimulation();
            addDebugInfo('Szimulált mód indítva');
        }
        
        // Web Bluetooth API támogatás ellenőrzése
        function checkBluetoothSupport() {
            if (!navigator.bluetooth) {
                alert("A böngészője nem támogatja a Web Bluetooth API-t. Kérjük, használjon Chrome, Edge vagy Opera böngészőt.");
                scanBtn.disabled = true;
                scanPx1122Btn.disabled = true;
                return false;
            }
            
            return true;
        }
        
        // Eseménykezelő a kapcsolat megszakadásához
        function onDisconnected() {
            addDebugInfo('Eszköz kapcsolata megszakadt (gattserverdisconnected)');
            disconnectFromDevice();
        }
        
        // Inicializálás
        function init() {
            // Bluetooth támogatás ellenőrzése
            checkBluetoothSupport();
            
            // Eseménykezelők
            scanBtn.addEventListener('click', scanForDevices);
            scanPx1122Btn.addEventListener('click', scanForPx1122);
            disconnectBtn.addEventListener('click', disconnectFromDevice);
            simulateBtn.addEventListener('click', startSimulationOnly);
            
            // Alapértelmezett állapot
            updateConnectionStatus(false);
            resetGPSData();
            
            // Demo eszközök a listához
            discoveredDevices = [
                { name: 'PX1122R-EVB', id: 'px1122r-demo-001' },
                { name: 'PX1122R L1/L2 GPS', id: 'px1122r-demo-002' },
                { name: 'GPS Tracker', id: 'demo-gps-tracker' }
            ];
            
            updateDeviceList(discoveredDevices);
            
            // Debug információk megjelenítése
            addDebugInfo('Alkalmazás inicializálva');
            addDebugInfo('PX1122R GPS modul támogatással');
            
            // Debug információk automatikus megjelenítése
            setTimeout(() => {
                debugInfo.style.display = 'block';
            }, 1000);
        }
        
        // Alkalmazás indítása
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
