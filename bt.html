<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth GPS Olvasó</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0d3b66 0%, #1a5f7a 100%);
            color: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            line-height: 1.6;
        }
        
        .card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }
        
        .card-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #4ecdc4;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            display: inline-block;
            background: linear-gradient(to right, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: linear-gradient(to right, #ff6b6b, #ee5a52);
        }
        
        .data-display {
            margin-top: 20px;
        }
        
        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-label {
            font-weight: 600;
            color: #a5d8ff;
        }
        
        .data-value {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #ffd166;
        }
        
        .coordinates {
            font-size: 1.5rem;
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-top: 20px;
            font-weight: bold;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            background-color: rgba(0, 0, 0, 0.2);
        }
        
        .status.connected {
            background-color: rgba(76, 175, 80, 0.2);
            color: #81c784;
        }
        
        .status.disconnected {
            background-color: rgba(244, 67, 54, 0.2);
            color: #ef9a9a;
        }
        
        .status.scanning {
            background-color: rgba(33, 150, 243, 0.2);
            color: #90caf9;
            animation: pulse 1.5s infinite;
        }
        
        .status.error {
            background-color: rgba(255, 152, 0, 0.2);
            color: #ffcc80;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .instructions {
            margin-top: 30px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #4ecdc4;
        }
        
        .instructions ol {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .note {
            font-style: italic;
            color: #ffd166;
            border-left: 3px solid #ffd166;
            padding-left: 10px;
            margin-top: 10px;
        }
        
        .warning {
            color: #ff6b6b;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .log {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            word-wrap: break-word;
        }
        
        .log-title {
            color: #4ecdc4;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .error-details {
            background-color: rgba(255, 87, 34, 0.1);
            border-left: 4px solid #ff5722;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-bluetooth"></i> Bluetooth GPS Olvasó</h1>
            <p class="subtitle">Csatlakozz Bluetooth GPS eszközhöz és olvasd ki a valós GPS adatokat</p>
        </header>
        
        <div class="status disconnected" id="connectionStatus">
            <i class="fas fa-plug"></i> Nincs csatlakoztatva Bluetooth eszköz
        </div>
        
        <div class="card">
            <h2 class="card-title"><i class="fas fa-satellite"></i> Bluetooth Kapcsolat</h2>
            
            <div class="data-display">
                <div class="data-item">
                    <span class="data-label">Eszköz neve:</span>
                    <span class="data-value" id="deviceName">-</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Kapcsolat állapota:</span>
                    <span class="data-value" id="deviceStatus">Nem csatlakoztatva</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Utolsó frissítés:</span>
                    <span class="data-value" id="lastUpdate">-</span>
                </div>
            </div>
            
            <button class="btn" id="scanBtn">
                <i class="fas fa-search"></i> Bluetooth GPS eszköz keresése
            </button>
            <button class="btn btn-danger" id="disconnectBtn" disabled>
                <i class="fas fa-ban"></i> Kapcsolat bontása
            </button>
            
            <div class="log" id="logContainer" style="display: none;">
                <div class="log-title"><i class="fas fa-terminal"></i> Kapcsolódási napló</div>
                <div id="logContent"></div>
            </div>
        </div>
        
        <div class="card">
            <h2 class="card-title"><i class="fas fa-map-marked-alt"></i> GPS Adatok</h2>
            <div class="coordinates" id="coordinates">
                Nem érhető el GPS adat
            </div>
            
            <div class="data-display">
                <div class="data-item">
                    <span class="data-label">Szélesség:</span>
                    <span class="data-value" id="latitude">-</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Hosszúság:</span>
                    <span class="data-value" id="longitude">-</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Magasság:</span>
                    <span class="data-value" id="altitude">-</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Sebesség:</span>
                    <span class="data-value" id="speed">-</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Műholdak száma:</span>
                    <span class="data-value" id="satellites">-</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Adatminőség:</span>
                    <span class="data-value" id="fixQuality">-</span>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> Bluetooth GPS csatlakozási útmutató</h3>
            <ol>
                <li><strong>GPS eszköz bekapcsolása:</strong> Kapcsold be a Bluetooth GPS eszközöd és győződj meg róla, hogy látható módban van (pairing mode).</li>
                <li><strong>Bluetooth engedélyezése:</strong> Győződj meg róla, hogy a számítógépeden/telefonodon be van kapcsolva a Bluetooth.</li>
                <li><strong>Eszköz keresése:</strong> Kattints a "Bluetooth GPS eszköz keresése" gombra.</li>
                <li><strong>Eszköz kiválasztása:</strong> A böngésző megjelenít egy listát az elérhető Bluetooth eszközökről. Válaszd ki a GPS eszközödet.</li>
                <li><strong>Kapcsolódás:</strong> A böngésző megkérdezi, hogy engedélyezed-e a kapcsolódást. Kattints a "Pair" vagy "Connect" gombra.</li>
                <li><strong>Adatok olvasása:</strong> Ha sikeres a kapcsolódás, a GPS adatok megjelennek a képernyőn.</li>
            </ol>
            
            <div class="warning">
                <i class="fas fa-exclamation-triangle"></i> Fontos: A Web Bluetooth API csak bizonyos böngészőkben működik megfelelően (Chrome, Edge, Opera). Győződj meg róla, hogy HTTPS kapcsolaton vagy localhost-on futtatod az alkalmazást.
            </div>
            
            <div class="error-details" id="errorDetails" style="display: none;">
                <h4><i class="fas fa-bug"></i> Kapcsolódási hiba részletei</h4>
                <div id="errorContent"></div>
            </div>
        </div>
        
        <footer>
            <p>Bluetooth GPS Olvasó &copy; 2023 | Web Bluetooth API - Valós kapcsolódás</p>
            <p>Ez az alkalmazás valós Bluetooth GPS eszközökhöz csatlakozik és olvassa ki az adatokat.</p>
        </footer>
    </div>

    <script>
        // DOM elemek
        const scanBtn = document.getElementById('scanBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const deviceName = document.getElementById('deviceName');
        const deviceStatus = document.getElementById('deviceStatus');
        const lastUpdate = document.getElementById('lastUpdate');
        const coordinates = document.getElementById('coordinates');
        const latitude = document.getElementById('latitude');
        const longitude = document.getElementById('longitude');
        const altitude = document.getElementById('altitude');
        const speed = document.getElementById('speed');
        const satellites = document.getElementById('satellites');
        const fixQuality = document.getElementById('fixQuality');
        const logContainer = document.getElementById('logContainer');
        const logContent = document.getElementById('logContent');
        const errorDetails = document.getElementById('errorDetails');
        const errorContent = document.getElementById('errorContent');
        
        // Web Bluetooth változók
        let bluetoothDevice = null;
        let gattServer = null;
        let gpsCharacteristic = null;
        let isConnected = false;
        
        // Napló bejegyzés hozzáadása
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('hu-HU');
            const typeIcon = type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `${typeIcon} [${timestamp}] ${message}`;
            logEntry.style.marginBottom = '5px';
            logEntry.style.color = type === 'error' ? '#ff6b6b' : type === 'warning' ? '#ffd166' : '#a5d8ff';
            
            logContent.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            logContainer.style.display = 'block';
        }
        
        // Hiba részletek megjelenítése
        function showErrorDetails(error) {
            let errorHtml = `
                <p><strong>Hiba típusa:</strong> ${error.name || 'Ismeretlen'}</p>
                <p><strong>Hibaüzenet:</strong> ${error.message || 'Nincs hibaüzenet'}</p>
            `;
            
            if (error.stack) {
                errorHtml += `<p><strong>Hiba részletek:</strong></p><pre style="font-size: 0.8rem; overflow-x: auto;">${error.stack}</pre>`;
            }
            
            errorContent.innerHTML = errorHtml;
            errorDetails.style.display = 'block';
        }
        
        // GPS adatok frissítése a felületen
        function updateGPSData(lat, lon, alt, spd, sat, fix) {
            // Frissítés a felületen
            if (lat !== null && lon !== null) {
                const latDirection = lat >= 0 ? 'É' : 'D';
                const lonDirection = lon >= 0 ? 'K' : 'Ny';
                const latAbs = Math.abs(lat).toFixed(4);
                const lonAbs = Math.abs(lon).toFixed(4);
                
                coordinates.textContent = `${latAbs}° ${latDirection}, ${lonAbs}° ${lonDirection}`;
                latitude.textContent = `${lat.toFixed(6)}°`;
                longitude.textContent = `${lon.toFixed(6)}°`;
            }
            
            if (alt !== null) {
                altitude.textContent = `${alt.toFixed(1)} m`;
            }
            
            if (spd !== null) {
                speed.textContent = `${(spd * 3.6).toFixed(1)} km/h`;
            }
            
            if (sat !== null) {
                satellites.textContent = sat;
            }
            
            if (fix !== null) {
                const fixQualities = {
                    '0': 'Érvénytelen',
                    '1': 'GPS fix',
                    '2': 'DGPS fix',
                    '3': 'PPS fix',
                    '4': 'RTK fix',
                    '5': 'RTK float',
                    '6': 'Becsült',
                    '7': 'Kézi bevitel',
                    '8': 'Szimuláció'
                };
                fixQuality.textContent = fixQualities[fix] || `Ismeretlen (${fix})`;
            }
            
            // Utolsó frissítés ideje
            const now = new Date();
            lastUpdate.textContent = now.toLocaleTimeString('hu-HU');
        }
        
        // Kapcsolat állapotának frissítése
        function updateConnectionStatus(connected, device = null) {
            isConnected = connected;
            
            if (connected) {
                connectionStatus.className = 'status connected';
                connectionStatus.innerHTML = `<i class="fas fa-link"></i> Csatlakozva: ${device ? device.name : 'Bluetooth eszköz'}`;
                scanBtn.disabled = true;
                disconnectBtn.disabled = false;
                deviceStatus.textContent = 'Csatlakozva';
                deviceStatus.style.color = '#81c784';
                
                if (device) {
                    deviceName.textContent = device.name || 'Ismeretlen eszköz';
                }
                
                addLog(`Sikeresen csatlakozva: ${device ? device.name : 'Ismeretlen eszköz'}`, 'info');
                
            } else {
                connectionStatus.className = 'status disconnected';
                connectionStatus.innerHTML = '<i class="fas fa-unlink"></i> Nincs csatlakoztatva Bluetooth eszköz';
                scanBtn.disabled = false;
                disconnectBtn.disabled = true;
                deviceStatus.textContent = 'Nem csatlakoztatva';
                deviceStatus.style.color = '#ef9a9a';
                deviceName.textContent = '-';
                
                // GPS adatok visszaállítása
                resetGPSData();
            }
        }
        
        // GPS adatok visszaállítása
        function resetGPSData() {
            coordinates.textContent = 'Nem érhető el GPS adat';
            latitude.textContent = '-';
            longitude.textContent = '-';
            altitude.textContent = '-';
            speed.textContent = '-';
            satellites.textContent = '-';
            fixQuality.textContent = '-';
            lastUpdate.textContent = '-';
        }
        
        // Web Bluetooth API támogatás ellenőrzése
        function checkBluetoothSupport() {
            if (!navigator.bluetooth) {
                const errorMsg = 'A böngészője nem támogatja a Web Bluetooth API-t. Kérjük, használjon Chrome, Edge vagy Opera böngészőt.';
                addLog(errorMsg, 'error');
                alert(errorMsg);
                return false;
            }
            
            // Ellenőrizzük, hogy a Bluetooth elérhető-e
            return navigator.bluetooth.getAvailability().then(available => {
                if (!available) {
                    const errorMsg = 'Bluetooth nem elérhető ezen az eszközön. Ellenőrizze, hogy be van-e kapcsolva a Bluetooth.';
                    addLog(errorMsg, 'error');
                    alert(errorMsg);
                    return false;
                }
                return true;
            }).catch(error => {
                addLog(`Bluetooth elérhetőség ellenőrzése sikertelen: ${error.message}`, 'error');
                return false;
            });
        }
        
        // Bluetooth eszközök keresése és csatlakozás
        async function scanAndConnect() {
            try {
                // Bluetooth támogatás ellenőrzése
                const isAvailable = await checkBluetoothSupport();
                if (!isAvailable) {
                    updateConnectionStatus(false);
                    return;
                }
                
                connectionStatus.className = 'status scanning';
                connectionStatus.innerHTML = '<i class="fas fa-search"></i> Bluetooth eszközök keresése...';
                addLog('Bluetooth eszközök keresése megkezdve...', 'info');
                
                // Bluetooth eszköz kiválasztása - minimális opciókkal
                const options = {
                    acceptAllDevices: true, // Minden eszköz megjelenjen
                    optionalServices: [] // Ne szűrjünk szolgáltatások alapján
                };
                
                addLog('A böngésző Bluetooth párbeszédpanelének megnyitása...', 'info');
                
                // Bluetooth eszköz kiválasztása
                bluetoothDevice = await navigator.bluetooth.requestDevice(options);
                
                if (!bluetoothDevice) {
                    addLog('Felhasználó megszakította az eszköz kiválasztását', 'warning');
                    updateConnectionStatus(false);
                    return;
                }
                
                addLog(`Eszköz kiválasztva: ${bluetoothDevice.name || 'Név nélküli eszköz'} (ID: ${bluetoothDevice.id || 'N/A'})`, 'info');
                
                // Eseménykezelő a kapcsolat megszakadásához
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
                // Kapcsolódás az eszközhöz
                connectionStatus.innerHTML = '<i class="fas fa-sync fa-spin"></i> Kapcsolódás az eszközhöz...';
                addLog('Kapcsolódás az eszközhöz...', 'info');
                
                try {
                    gattServer = await bluetoothDevice.gatt.connect();
                    addLog('Sikeresen kapcsolódva a GATT szerverhez', 'info');
                } catch (connectError) {
                    addLog(`Hiba a GATT szerverhez való kapcsolódásnál: ${connectError.message}`, 'error');
                    showErrorDetails(connectError);
                    throw connectError;
                }
                
                // Szolgáltatások listázása
                connectionStatus.innerHTML = '<i class="fas fa-list"></i> Szolgáltatások keresése...';
                addLog('Szolgáltatások listázása...', 'info');
                
                let services;
                try {
                    services = await gattServer.getPrimaryServices();
                    addLog(`${services.length} szolgáltatás található`, 'info');
                } catch (serviceError) {
                    addLog(`Hiba a szolgáltatások lekérésekor: ${serviceError.message}`, 'error');
                    showErrorDetails(serviceError);
                    throw serviceError;
                }
                
                // Szolgáltatások naplózása
                for (let i = 0; i < services.length; i++) {
                    const service = services[i];
                    addLog(`Szolgáltatás ${i + 1}: ${service.uuid}`, 'info');
                    
                    // Próbáljuk megkapni a karakterisztikákat
                    try {
                        const characteristics = await service.getCharacteristics();
                        addLog(`  - ${characteristics.length} karakterisztika`, 'info');
                        
                        for (let j = 0; j < characteristics.length; j++) {
                            const char = characteristics[j];
                            addLog(`    Karakterisztika ${j + 1}: ${char.uuid} (Tulajdonságok: ${char.properties})`, 'info');
                            
                            // Ha találunk egy olvasható karakterisztikát, próbáljuk megolvasni
                            if (char.properties.read) {
                                try {
                                    const value = await char.readValue();
                                    const decoder = new TextDecoder();
                                    const text = decoder.decode(value);
                                    addLog(`    Érték: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`, 'info');
                                    
                                    // Ha ez GPS adatnak tűnik (NMEA formátum)
                                    if (text.includes('$GP') || text.includes('$GN')) {
                                        gpsCharacteristic = char;
                                        addLog('GPS karakterisztika találva!', 'info');
                                        
                                        // Próbáljunk feliratkozni az értesítésekre
                                        if (char.properties.notify) {
                                            await char.startNotifications();
                                            char.addEventListener('characteristicvaluechanged', handleGPSData);
                                            addLog('Feliratkozva a GPS adatokra', 'info');
                                        }
                                    }
                                } catch (readError) {
                                    addLog(`    Hiba az olvasásnál: ${readError.message}`, 'warning');
                                }
                            }
                        }
                    } catch (charError) {
                        addLog(`  - Hiba a karakterisztikák lekérésekor: ${charError.message}`, 'warning');
                    }
                }
                
                // Ha nem találtunk GPS karakterisztikát, de sikeresen csatlakoztunk
                updateConnectionStatus(true, bluetoothDevice);
                addLog('Kapcsolódás sikeres. Várakozás GPS adatokra...', 'info');
                
            } catch (error) {
                console.error('Hiba a kapcsolódás során:', error);
                
                if (error.name === 'NotFoundError') {
                    addLog('Felhasználó megszakította az eszköz kiválasztását', 'warning');
                    connectionStatus.className = 'status disconnected';
                    connectionStatus.innerHTML = '<i class="fas fa-times-circle"></i> Nincs Bluetooth eszköz kiválasztva';
                } else if (error.name === 'SecurityError') {
                    addLog('Biztonsági hiba: Nincs engedély a Bluetooth használatához', 'error');
                    connectionStatus.className = 'status error';
                    connectionStatus.innerHTML = '<i class="fas fa-shield-alt"></i> Biztonsági hiba: Nincs engedély';
                } else {
                    addLog(`Hiba: ${error.message}`, 'error');
                    showErrorDetails(error);
                    connectionStatus.className = 'status error';
                    connectionStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> Hiba: ${error.message}`;
                }
                
                updateConnectionStatus(false);
            }
        }
        
        // GPS adatok kezelése
        function handleGPSData(event) {
            try {
                const value = event.target.value;
                const decoder = new TextDecoder();
                const textData = decoder.decode(value);
                
                addLog(`GPS adat érkezett: ${textData.substring(0, 50)}${textData.length > 50 ? '...' : ''}`, 'info');
                
                // Egyszerű NMEA feldolgozás (demo célokra)
                // Valós alkalmazásban itt kellene teljes NMEA parser-t implementálni
                if (textData.includes('$GPGGA') || textData.includes('$GNGGA')) {
                    const parts = textData.split(',');
                    
                    if (parts.length >= 10) {
                        // Szélesség
                        if (parts[2] && parts[3]) {
                            const latDeg = parseFloat(parts[2].substring(0, 2));
                            const latMin = parseFloat(parts[2].substring(2));
                            const latValue = latDeg + (latMin / 60);
                            const lat = parts[3] === 'S' ? -latValue : latValue;
                            
                            // Hosszúság
                            const lonDeg = parseFloat(parts[4].substring(0, 3));
                            const lonMin = parseFloat(parts[4].substring(3));
                            const lonValue = lonDeg + (lonMin / 60);
                            const lon = parts[5] === 'W' ? -lonValue : lonValue;
                            
                            // Magasság
                            const alt = parts[9] ? parseFloat(parts[9]) : null;
                            
                            // Műholdak száma
                            const sat = parts[7] ? parseInt(parts[7]) : null;
                            
                            // Fix minőség
                            const fix = parts[6] || null;
                            
                            updateGPSData(lat, lon, alt, 0, sat, fix);
                        }
                    }
                }
                
            } catch (error) {
                addLog(`Hiba a GPS adatok feldolgozásakor: ${error.message}`, 'error');
            }
        }
        
        // Kapcsolat bontása
        function disconnectFromDevice() {
            addLog('Kapcsolat bontása...', 'info');
            
            if (bluetoothDevice && bluetoothDevice.gatt) {
                if (bluetoothDevice.gatt.connected) {
                    bluetoothDevice.gatt.disconnect();
                    addLog('Kapcsolat megszakítva', 'info');
                }
            }
            
            if (gpsCharacteristic) {
                try {
                    if (gpsCharacteristic.properties.notify) {
                        gpsCharacteristic.stopNotifications();
                        gpsCharacteristic.removeEventListener('characteristicvaluechanged', handleGPSData);
                        addLog('GPS értesítések leállítva', 'info');
                    }
                } catch (e) {
                    addLog(`Hiba az értesítések leállításakor: ${e.message}`, 'warning');
                }
                gpsCharacteristic = null;
            }
            
            bluetoothDevice = null;
            gattServer = null;
            
            updateConnectionStatus(false);
            addLog('Kapcsolat teljesen bontva', 'info');
        }
        
        // Eseménykezelő a kapcsolat megszakadásához
        function onDisconnected() {
            addLog('Eszköz kapcsolata megszakadt (gattserverdisconnected)', 'warning');
            disconnectFromDevice();
        }
        
        // Inicializálás
        function init() {
            // Eseménykezelők
            scanBtn.addEventListener('click', scanAndConnect);
            disconnectBtn.addEventListener('click', disconnectFromDevice);
            
            // Alapértelmezett állapot
            updateConnectionStatus(false);
            resetGPSData();
            
            // Napló inicializálása
            addLog('Alkalmazás inicializálva', 'info');
            addLog('Kattints a "Bluetooth GPS eszköz keresése" gombra a kapcsolódáshoz', 'info');
            
            // Böngésző információk naplózása
            addLog(`Böngésző: ${navigator.userAgent.substring(0, 50)}...`, 'info');
            
            // Web Bluetooth API támogatás ellenőrzése
            if (!navigator.bluetooth) {
                addLog('Figyelem: A böngésző nem támogatja a Web Bluetooth API-t', 'error');
            } else {
                navigator.bluetooth.getAvailability().then(available => {
                    if (available) {
                        addLog('Bluetooth elérhető ezen az eszközön', 'info');
                    } else {
                        addLog('Bluetooth nem elérhető ezen az eszközön', 'warning');
                    }
                }).catch(error => {
                    addLog(`Hiba a Bluetooth elérhetőség ellenőrzésekor: ${error.message}`, 'error');
                });
            }
        }
        
        // Alkalmazás indítása
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
