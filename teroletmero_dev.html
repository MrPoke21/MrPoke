<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KML Poligon Elemz≈ë √©s M√©r≈ë</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
            margin: 0;
        }
        
        .content {
            display: flex;
            flex: 1;
            padding: 0;
            gap: 0;
            overflow: hidden;
            height: calc(100vh - 60px);
        }
        
        @media (max-width: 1200px) {
            .content {
                flex-direction: column;
            }
        }
        
        .map-container {
            flex: 3;
            position: relative;
            min-height: 300px;
            height: 100%;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .sidebar {
            flex: 1.2;
            background-color: white;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-width: 350px;
            max-width: 450px;
            overflow-y: auto;
            border-left: 1px solid #ddd;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }
        
        .section-title {
            font-size: 1.4rem;
            color: #2c3e50;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #3498db;
            margin-bottom: 0.5rem;
        }
        
        .file-upload {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        
        .upload-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.9rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .upload-btn:hover {
            background-color: #2980b9;
        }
        
        .location-info, .distance-info, .element-info {
            background-color: #f8f9fa;
            padding: 1.2rem;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .element-info {
            border-left-color: #e74c3c;
        }
        
        .info-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .info-value {
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }
        
        .info-value.highlight {
            color: #e74c3c;
            font-weight: 700;
        }
        
        .instructions {
            font-size: 0.95rem;
            color: #7f8c8d;
            line-height: 1.5;
        }
        
        .icon {
            font-size: 1.2rem;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            margin-top: 0.5rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        
        .user-location {
            background-color: #3498db;
        }
        
        .polygon-corner {
            background-color: #e74c3c;
        }
        
        .polygon-side {
            background-color: #2ecc71;
            border-radius: 0;
            width: 20px;
            height: 4px;
        }
        
        .polygon-original {
            background-color: #9b59b6;
        }
        
        .selected-element {
            background-color: #f39c12;
        }
        
        .measurement-line {
            background-color: #e74c3c;
            border-radius: 0;
            width: 20px;
            height: 3px;
        }
        
        .extended-line {
            background-color: #95a5a6;
            border-radius: 0;
            width: 20px;
            height: 2px;
        }
        
        .file-name {
            font-size: 0.9rem;
            color: #7f8c8d;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            word-break: break-all;
        }
        
        .element-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .element-item {
            padding: 0.5rem;
            margin-bottom: 0.3rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .element-item:hover {
            background-color: #e9ecef;
        }
        
        .element-item.selected {
            background-color: #fff3cd;
            border-left: 3px solid #f39c12;
        }
        
        .element-type {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .element-coords {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .mode-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .mode-btn {
            flex: 1;
            padding: 0.7rem;
            border: 2px solid #ddd;
            background-color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .element-count {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 0.3rem;
        }
        
        /* Teljes k√©perny≈ës gombok */
        .fullscreen-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        .fullscreen-btn {
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #3498db;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
            color: #3498db;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .fullscreen-btn:hover {
            background-color: #3498db;
            color: white;
        }
        
        .toggle-sidebar-btn {
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #2ecc71;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
            color: #2ecc71;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .toggle-sidebar-btn:hover {
            background-color: #2ecc71;
            color: white;
        }
        
        /* Teljes k√©perny≈ës m√≥d st√≠lusok */
        body.fullscreen-mode {
            overflow: auto;
        }
        
        .fullscreen-mode .content {
            height: 100vh;
            padding: 0;
        }
        
        .fullscreen-mode .sidebar {
            display: none;
        }
        
        .fullscreen-mode .map-container {
            flex: 1;
            width: 100%;
        }
        
        .fullscreen-mode .fullscreen-controls {
            top: 20px;
            right: 20px;
        }
        
        /* Oldals√°v elrejt√©se/lenyit√°sa */
        .sidebar-hidden .sidebar {
            display: none;
        }
        
        .sidebar-hidden .map-container {
            flex: 1;
        }
        
        /* Fejl√©c (minim√°lis) */
        .mini-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }
        
        .mini-header h1 {
            font-size: 1.4rem;
            margin: 0;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .header-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }
        
        .header-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Poz√≠ci√≥ √°llapot jelz≈ëk */
        .position-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .position-status.high-accuracy {
            background-color: #2ecc71;
            box-shadow: 0 0 8px #2ecc71;
            animation: pulse-high 1s infinite;
        }
        
        .position-status.medium-accuracy {
            background-color: #f39c12;
            box-shadow: 0 0 6px #f39c12;
            animation: pulse-medium 1s infinite;
        }
        
        .position-status.low-accuracy {
            background-color: #e74c3c;
            box-shadow: 0 0 4px #e74c3c;
        }
        
        .position-status.inactive {
            background-color: #95a5a6;
        }
        
        @keyframes pulse-high {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        @keyframes pulse-medium {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Hiba√ºzenetek */
        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 5px;
            padding: 5px;
            background-color: rgba(231, 76, 60, 0.1);
            border-radius: 4px;
        }
        
        /* Firefox specifikus be√°ll√≠t√°sok */
        .firefox-optimization {
            margin-top: 10px;
            padding: 10px;
            background-color: #e8f4fc;
            border-radius: 6px;
            border: 1px solid #3498db;
            font-size: 0.85rem;
        }
        
        .firefox-optimization h4 {
            color: #3498db;
            margin-bottom: 5px;
        }
        
        .accuracy-indicator {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        
        .accuracy-bar {
            flex: 1;
            height: 8px;
            background-color: #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin: 0 10px;
        }
        
        .accuracy-fill {
            height: 100%;
            background-color: #2ecc71;
            transition: width 0.5s;
        }
        
        .accuracy-text {
            font-weight: 600;
            min-width: 60px;
        }
        
        .high-accuracy-text {
            color: #2ecc71;
        }
        
        .medium-accuracy-text {
            color: #f39c12;
        }
        
        .low-accuracy-text {
            color: #e74c3c;
        }
        
        /* GPS t√≠pus jelz≈ë */
        .gps-type {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
        }
        
        .gps-high {
            background-color: #d5f4e6;
            color: #27ae60;
        }
        
        .gps-medium {
            background-color: #fef9e7;
            color: #f39c12;
        }
        
        .gps-low {
            background-color: #fadbd8;
            color: #e74c3c;
        }
        
        /* B√∂ng√©sz≈ë inf√≥ */
        .browser-info {
            font-size: 0.8rem;
            color: #7f8c8d;
            padding: 3px;
            background-color: #f8f9fa;
            border-radius: 3px;
            margin-top: 5px;
        }
        /* Bluetooth specific styles */
        .bluetooth-section {
            background-color: #f0f8ff;
            padding: 1.2rem;
            border-radius: 8px;
            border-left: 4px solid #4a6fa5;
            margin-top: 1rem;
        }
        
        .bluetooth-controls {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-top: 0.8rem;
        }
        
        .bluetooth-btn {
            background-color: #4a6fa5;
            color: white;
            border: none;
            padding: 0.7rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.3s;
        }
        
        .bluetooth-btn:hover {
            background-color: #3a5a8a;
        }
        
        .bluetooth-btn.disconnected {
            background-color: #95a5a6;
        }
        
        .bluetooth-btn.connected {
            background-color: #2ecc71;
        }
        
        .bluetooth-btn.scanning {
            background-color: #f39c12;
            animation: pulse-scanning 1.5s infinite;
        }
        
        @keyframes pulse-scanning {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .bluetooth-status {
            font-size: 0.9rem;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
        }
        
        .bluetooth-status.connected {
            background-color: #d5f4e6;
            color: #27ae60;
            border: 1px solid #2ecc71;
        }
        
        .bluetooth-status.disconnected {
            background-color: #fadbd8;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .bluetooth-status.scanning {
            background-color: #fef9e7;
            color: #f39c12;
            border: 1px solid #f39c12;
        }
        
        .device-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            background-color: white;
        }
        
        .device-item {
            padding: 0.6rem;
            margin-bottom: 0.3rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .device-item:hover {
            background-color: #e9ecef;
        }
        
        .device-item.selected {
            background-color: #e8f4fc;
            border-left: 3px solid #3498db;
        }
        
        .device-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .device-id {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .nmea-data {
            font-family: monospace;
            font-size: 0.8rem;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 0.5rem;
            border-radius: 4px;
            overflow-x: auto;
            white-space: nowrap;
            margin-top: 0.5rem;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .gps-source-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.8rem;
        }
        
        .source-btn {
            flex: 1;
            padding: 0.6rem;
            border: 2px solid #ddd;
            background-color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .source-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .source-btn.internal {
            border-color: #2ecc71;
        }
        
        .source-btn.internal.active {
            background-color: #2ecc71;
            border-color: #2ecc71;
        }
        
        .source-btn.bluetooth {
            border-color: #4a6fa5;
        }
        
        .source-btn.bluetooth.active {
            background-color: #4a6fa5;
            border-color: #4a6fa5;
        }
        
        .satellite-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        .satellite-count {
            background-color: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }
        
        .signal-strength {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .signal-bar {
            width: 12px;
            height: 4px;
            background-color: #ddd;
            border-radius: 2px;
        }
        
        .signal-bar.active {
            background-color: #2ecc71;
        }
        
        .signal-bar.medium {
            background-color: #f39c12;
        }
        
        .signal-bar.weak {
            background-color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="mini-header">
        <h1>KML Poligon Elemz≈ë √©s M√©r≈ë</h1>
        <div class="header-controls">
            <button id="headerFullscreenBtn" class="header-btn">
                <span class="icon">üì∫</span>
                Teljes k√©perny≈ë
            </button>
            <button id="headerToggleSidebarBtn" class="header-btn">
                <span class="icon">‚Üî</span>
                Oldals√°v
            </button>
        </div>
    </div>
    
    <div class="content">
        <div class="map-container">
            <div id="map"></div>
            <div class="fullscreen-controls">
                <button id="fullscreenBtn" class="fullscreen-btn">
                    <span class="icon">üì∫</span>
                    Teljes k√©perny≈ë
                </button>
                <button id="toggleSidebarBtn" class="toggle-sidebar-btn">
                    <span class="icon">‚Üî</span>
                    Oldals√°v
                </button>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="control-panel">
                <h2 class="section-title">KML F√°jl Bet√∂lt√©se</h2>
                <div class="file-upload">
                    <input type="file" id="kmlFile" accept=".kml,.xml" style="display: none;">
                    <button id="uploadBtn" class="upload-btn">
                        <span class="icon">üìÅ</span>
                        KML F√°jl Kiv√°laszt√°sa
                    </button>
                    <div id="fileName" class="file-name">Nincs f√°jl kiv√°lasztva</div>
                    <p class="instructions">V√°lassz ki egy KML f√°jlt, amely poligonokat tartalmaz. A program sz√©tbontja azokat sarkokra √©s oldalakra.</p>
                </div>
                
                <div class="mode-selector">
                    <button id="modeAll" class="mode-btn active">√ñsszes elem</button>
                    <button id="modeCorners" class="mode-btn">Csak sarkok</button>
                    <button id="modeSides" class="mode-btn">Csak oldalak</button>
                </div>
                
                <h2 class="section-title">Poligon Elemek</h2>
                <div class="element-info">
                    <div class="info-title">
                        <span class="icon">üîç</span>
                        Kiv√°lasztott poligon
                    </div>
                    <div id="selectedPolygon" class="info-value">-</div>
                    <div id="elementCount" class="element-count">0 sarok, 0 oldal</div>
                    
                    <div class="info-title" style="margin-top: 1rem;">
                        <span class="icon">üìç</span>
                        Elemek list√°ja
                    </div>
                    <div id="elementsList" class="element-list">
                        <!-- Elemek list√°ja jelenik meg itt -->
                    </div>
                </div>
                
                <h2 class="section-title">Helyzet inform√°ci√≥k</h2>
                <div class="location-info">
                    <div class="info-title">
                        <span class="position-status inactive"></span>
                        <span>Jelenlegi poz√≠ci√≥</span>
                        <span id="gpsTypeBadge" class="gps-type" style="display: none;">GPS</span>
                    </div>
                    <div id="locationStatus" class="info-value">Inicializ√°l√°s...</div>
                    <div id="coordinates" class="info-value">-</div>
                    
                    <div class="accuracy-indicator">
                        <span>Pontoss√°g:</span>
                        <div class="accuracy-bar">
                            <div id="accuracyFill" class="accuracy-fill" style="width: 0%"></div>
                        </div>
                        <span id="accuracyText" class="accuracy-text">-</span>
                    </div>
                    
                    <div id="browserInfo" class="browser-info">-</div>
                    
                    <!-- Firefox specifikus optimaliz√°ci√≥ -->
                    <div id="firefoxOptimization" class="firefox-optimization" style="display: none;">
                        <h4>üîß Firefox GPS Optimaliz√°ci√≥</h4>
                        <p>Firefox alap√©rtelmezetten csak hozz√°vet≈ëleges poz√≠ci√≥t ad. Pr√≥b√°ljuk meg a k√∂vetkez≈ëket:</p>
                        <ul style="margin-left: 15px; margin-top: 5px;">
                            <li>Nyisd meg <strong>about:config</strong> √©s keresd: <em>geo.provider.network.url</em></li>
                            <li>√Åll√≠tsd <em>geo.enabled</em> √©rt√©k√©t <strong>true</strong>-ra</li>
                            <li>Pr√≥b√°ld ki a "GPS k√©nyszer√≠t√©se" gombot alul</li>
                        </ul>
                    </div>
                    
                    <div id="positionError" class="error-message" style="display: none;"></div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button id="forceGpsBtn" class="upload-btn" style="flex: 1; padding: 0.6rem; font-size: 0.9rem; background-color: #2ecc71;">
                            <span class="icon">üì°</span>
                            GPS K√©nyszer√≠t√©se
                        </button>
                        <button id="resetPositionBtn" class="upload-btn" style="flex: 1; padding: 0.6rem; font-size: 0.9rem; background-color: #3498db;">
                            <span class="icon">üîÑ</span>
                            √öjraind√≠t√°s
                        </button>
                    </div>
                </div>
                
                <h2 class="section-title">T√°vols√°g m√©r√©s</h2>
                <div class="distance-info">
                    <div class="info-title">
                        <span class="icon">üìè</span>
                        Kiv√°lasztott elem
                    </div>
                    <div id="selectedElement" class="info-value">Kattints egy sarokra vagy oldalra</div>
                    <div id="distanceInfo" class="info-value">-</div>
                    <div id="nearestPointInfo" class="info-value">-</div>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color user-location"></div>
                        <span>Felhaszn√°l√≥ helye</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color polygon-corner"></div>
                        <span>Poligon sarok</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color polygon-side"></div>
                        <span>Poligon oldal</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color polygon-original"></div>
                        <span>Eredeti poligon</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color selected-element"></div>
                        <span>Kiv√°lasztott elem</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color measurement-line"></div>
                        <span>M√©r√©si vonal</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color extended-line"></div>
                        <span>Kiterjesztett egyenes</span>
                    </div>
                </div>
            </div>
            
            <div class="instructions">
                <p><strong>Haszn√°lati √∫tmutat√≥:</strong></p>
                <ul>
                    <li>T√∂lts fel egy KML f√°jlt poligonokkal</li>
                    <li>A program automatikusan sz√©tbontja a poligonokat sarkokra √©s oldalakra</li>
                    <li>V√°lassz m√≥dot: √∂sszes elem, csak sarkok vagy csak oldalak</li>
                    <li>Kattints egy sarokra vagy oldalra a t√°vols√°g m√©r√©s√©hez</li>
                    <li>Sarok eset√©n: k√∂zvetlen t√°vols√°g a sarokpontt√≥l</li>
                    <li>Vonal eset√©n: t√°vols√°g a v√©gtelenbe kiterjesztett egyenest≈ël</li>
                    <li>Piros vonal: m√©r√©si vonal a helyzeted √©s a kiv√°lasztott elem k√∂z√∂tt</li>
                    <li>Sz√ºrke vonal: a kiterjesztett egyenes (100 m√©ter mindk√©t ir√°nyba)</li>
                    <li><strong>Firefox:</strong> Ha csak hozz√°vet≈ëleges poz√≠ci√≥t kapsz, pr√≥b√°ld a "GPS K√©nyszer√≠t√©se" gombot</li>
                    <li>A sz√°m√≠t√°sok 2D geometriai alap√∫ak</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="mini-header">
        <h1>KML Poligon Elemz≈ë √©s M√©r≈ë</h1>
        <div class="header-controls">
            <button id="headerFullscreenBtn" class="header-btn">
                <span class="icon">üì∫</span>
                Teljes k√©perny≈ë
            </button>
            <button id="headerToggleSidebarBtn" class="header-btn">
                <span class="icon">‚Üî</span>
                Oldals√°v
            </button>
        </div>
    </div>
    
    <div class="content">
        <div class="map-container">
            <div id="map"></div>
            <div class="fullscreen-controls">
                <button id="fullscreenBtn" class="fullscreen-btn">
                    <span class="icon">üì∫</span>
                    Teljes k√©perny≈ë
                </button>
                <button id="toggleSidebarBtn" class="toggle-sidebar-btn">
                    <span class="icon">‚Üî</span>
                    Oldals√°v
                </button>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="control-panel">
                <h2 class="section-title">GPS Forr√°s V√°laszt√°sa</h2>
                <div class="gps-source-selector">
                    <button id="sourceInternal" class="source-btn internal active">Bels≈ë GPS</button>
                    <button id="sourceBluetooth" class="source-btn bluetooth">Bluetooth GPS</button>
                </div>
                
                <!-- Bluetooth GPS Section (initially hidden) -->
                <div id="bluetoothSection" class="bluetooth-section" style="display: none;">
                    <div class="info-title">
                        <span class="icon">üì°</span>
                        Bluetooth GPS
                    </div>
                    
                    <div class="bluetooth-controls">
                        <button id="bluetoothScanBtn" class="bluetooth-btn">
                            <span class="icon">üîç</span>
                            Eszk√∂z√∂k Keres√©se
                        </button>
                        
                        <div id="bluetoothStatus" class="bluetooth-status disconnected">
                            Bluetooth: Kapcsolat n√©lk√ºl
                        </div>
                        
                        <div id="deviceList" class="device-list" style="display: none;">
                            <!-- Bluetooth eszk√∂z√∂k list√°ja -->
                        </div>
                        
                        <div id="nmeaContainer" style="display: none;">
                            <div class="info-title" style="margin-top: 0.5rem; font-size: 1rem;">
                                <span class="icon">üì°</span>
                                NMEA Adatok
                            </div>
                            <div id="nmeaData" class="nmea-data">
                                <!-- NMEA adatok jelennek meg itt -->
                            </div>
                            
                            <div class="satellite-info">
                                <span>M≈±holdak:</span>
                                <span id="satelliteCount" class="satellite-count">0</span>
                                <div class="signal-strength">
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                    <div class="signal-bar"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h2 class="section-title">KML F√°jl Bet√∂lt√©se</h2>
                <div class="file-upload">
                    <input type="file" id="kmlFile" accept=".kml,.xml" style="display: none;">
                    <button id="uploadBtn" class="upload-btn">
                        <span class="icon">üìÅ</span>
                        KML F√°jl Kiv√°laszt√°sa
                    </button>
                    <div id="fileName" class="file-name">Nincs f√°jl kiv√°lasztva</div>
                    <p class="instructions">V√°lassz ki egy KML f√°jlt, amely poligonokat tartalmaz. A program sz√©tbontja azokat sarkokra √©s oldalakra.</p>
                </div>
                
                <div class="mode-selector">
                    <button id="modeAll" class="mode-btn active">√ñsszes elem</button>
                    <button id="modeCorners" class="mode-btn">Csak sarkok</button>
                    <button id="modeSides" class="mode-btn">Csak oldalak</button>
                </div>
                
                <h2 class="section-title">Poligon Elemek</h2>
                <div class="element-info">
                    <div class="info-title">
                        <span class="icon">üîç</span>
                        Kiv√°lasztott poligon
                    </div>
                    <div id="selectedPolygon" class="info-value">-</div>
                    <div id="elementCount" class="element-count">0 sarok, 0 oldal</div>
                    
                    <div class="info-title" style="margin-top: 1rem;">
                        <span class="icon">üìç</span>
                        Elemek list√°ja
                    </div>
                    <div id="elementsList" class="element-list">
                        <!-- Elemek list√°ja jelenik meg itt -->
                    </div>
                </div>
                
                <h2 class="section-title">Helyzet inform√°ci√≥k</h2>
                <div class="location-info">
                    <div class="info-title">
                        <span class="position-status inactive"></span>
                        <span>Jelenlegi poz√≠ci√≥</span>
                        <span id="gpsTypeBadge" class="gps-type" style="display: none;">GPS</span>
                    </div>
                    <div id="locationStatus" class="info-value">Inicializ√°l√°s...</div>
                    <div id="coordinates" class="info-value">-</div>
                    
                    <div class="accuracy-indicator">
                        <span>Pontoss√°g:</span>
                        <div class="accuracy-bar">
                            <div id="accuracyFill" class="accuracy-fill" style="width: 0%"></div>
                        </div>
                        <span id="accuracyText" class="accuracy-text">-</span>
                    </div>
                    
                    <div id="browserInfo" class="browser-info">-</div>
                    
                    <!-- Firefox specifikus optimaliz√°ci√≥ -->
                    <div id="firefoxOptimization" class="firefox-optimization" style="display: none;">
                        <h4>üîß Firefox GPS Optimaliz√°ci√≥</h4>
                        <p>Firefox alap√©rtelmezetten csak hozz√°vet≈ëleges poz√≠ci√≥t ad. Pr√≥b√°ljuk meg a k√∂vetkez≈ëket:</p>
                        <ul style="margin-left: 15px; margin-top: 5px;">
                            <li>Nyisd meg <strong>about:config</strong> √©s keresd: <em>geo.provider.network.url</em></li>
                            <li>√Åll√≠tsd <em>geo.enabled</em> √©rt√©k√©t <strong>true</strong>-ra</li>
                            <li>Pr√≥b√°ld ki a "GPS k√©nyszer√≠t√©se" gombot alul</li>
                        </ul>
                    </div>
                    
                    <div id="positionError" class="error-message" style="display: none;"></div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button id="forceGpsBtn" class="upload-btn" style="flex: 1; padding: 0.6rem; font-size: 0.9rem; background-color: #2ecc71;">
                            <span class="icon">üì°</span>
                            GPS K√©nyszer√≠t√©se
                        </button>
                        <button id="resetPositionBtn" class="upload-btn" style="flex: 1; padding: 0.6rem; font-size: 0.9rem; background-color: #3498db;">
                            <span class="icon">üîÑ</span>
                            √öjraind√≠t√°s
                        </button>
                    </div>
                </div>
                
                <h2 class="section-title">T√°vols√°g m√©r√©s</h2>
                <div class="distance-info">
                    <div class="info-title">
                        <span class="icon">üìè</span>
                        Kiv√°lasztott elem
                    </div>
                    <div id="selectedElement" class="info-value">Kattints egy sarokra vagy oldalra</div>
                    <div id="distanceInfo" class="info-value">-</div>
                    <div id="nearestPointInfo" class="info-value">-</div>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color user-location"></div>
                        <span>Felhaszn√°l√≥ helye</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color polygon-corner"></div>
                        <span>Poligon sarok</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color polygon-side"></div>
                        <span>Poligon oldal</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color polygon-original"></div>
                        <span>Eredeti poligon</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color selected-element"></div>
                        <span>Kiv√°lasztott elem</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color measurement-line"></div>
                        <span>M√©r√©si vonal</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color extended-line"></div>
                        <span>Kiterjesztett egyenes</span>
                    </div>
                </div>
            </div>
            
            <div class="instructions">
                <p><strong>Haszn√°lati √∫tmutat√≥:</strong></p>
                <ul>
                    <li>T√∂lts fel egy KML f√°jlt poligonokkal</li>
                    <li>A program automatikusan sz√©tbontja a poligonokat sarkokra √©s oldalakra</li>
                    <li>V√°lassz m√≥dot: √∂sszes elem, csak sarkok vagy csak oldalak</li>
                    <li>Kattints egy sarokra vagy oldalra a t√°vols√°g m√©r√©s√©hez</li>
                    <li>Sarok eset√©n: k√∂zvetlen t√°vols√°g a sarokpontt√≥l</li>
                    <li>Vonal eset√©n: t√°vols√°g a v√©gtelenbe kiterjesztett egyenest≈ël</li>
                    <li>Piros vonal: m√©r√©si vonal a helyzeted √©s a kiv√°lasztott elem k√∂z√∂tt</li>
                    <li>Sz√ºrke vonal: a kiterjesztett egyenes (100 m√©ter mindk√©t ir√°nyba)</li>
                    <li><strong>Firefox:</strong> Ha csak hozz√°vet≈ëleges poz√≠ci√≥t kapsz, pr√≥b√°ld a "GPS K√©nyszer√≠t√©se" gombot</li>
                    <li>A sz√°m√≠t√°sok 2D geometriai alap√∫ak</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ========== GLOBAL VARIABLES ==========
        let map = null; // Will be initialized after DOM loads
        let userMarker = null;
        let userLatLng = null;
        let originalPolygons = [];
        let polygonElements = [];
        let displayedElements = [];
        let measurementLine = null;
        let extendedLine = null;
        let lastClickedElement = null;
        let currentMode = 'all';
        let isFullscreen = false;
        let sidebarVisible = true;
        let watchId = null;
        let forceGpsMode = false;
        let isFirefox = false;
        let accuracyHistory = [];
        
        // Bluetooth GPS variables
        let gpsSource = 'internal';
        let bluetoothDevice = null;
        let bluetoothCharacteristic = null;
        let nmeaParser = null;
        let satelliteCount = 0;
        let bluetoothReconnectInterval = null;
        
        // ========== CORE GPS FUNCTIONS ==========
        
        // Poz√≠ci√≥ k√∂vet√©s le√°ll√≠t√°sa
        function stopPositionTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            forceGpsMode = false;
        }
        
        // Poz√≠ci√≥ feldolgoz√°sa
        function processPosition(position) {
            const newUserLatLng = [position.coords.latitude, position.coords.longitude];
            userLatLng = newUserLatLng;
            
            document.getElementById('coordinates').innerHTML = 
                `<span class="highlight">${userLatLng[0].toFixed(6)}¬∞, ${userLatLng[1].toFixed(6)}¬∞</span>`;
            
            updateAccuracyStatus(position.coords.accuracy);
            
            if (userMarker) {
                userMarker.setLatLng(userLatLng);
            } else if (map) {
                userMarker = L.marker(userLatLng, {
                    icon: L.divIcon({
                        className: 'user-location-icon',
                        html: '<div style="background-color:#3498db;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>',
                        iconSize: [26, 26],
                        iconAnchor: [13, 13]
                    })
                }).addTo(map);
                
                userMarker.bindTooltip(`Poz√≠ci√≥ (${position.coords.accuracy.toFixed(0)}m)`, {permanent: false, direction: 'top'}).openTooltip();
            }
            
            if (lastClickedElement) {
                updateMeasurement(lastClickedElement);
            }
            
            hidePositionError();
        }
        
        // Poz√≠ci√≥ hiba kezel√©se
        function handlePositionError(error) {
            console.error("Helymeghat√°roz√°si hiba:", error);
            
            if (gpsSource === 'internal') {
                let errorMessage = "Hiba: ";
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += "Hozz√°f√©r√©s megtagadva. Enged√©lyezd a helymeghat√°roz√°st!";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += "Helyinform√°ci√≥ nem el√©rhet≈ë. Ellen≈ërizd a GPS-t!";
                        break;
                    case error.TIMEOUT:
                        errorMessage += "Id≈ët√∫ll√©p√©s. Pr√≥b√°ld √∫jra!";
                        break;
                    default:
                        errorMessage += "Ismeretlen hiba.";
                        break;
                }
                
                if (isFirefox && error.code === error.POSITION_UNAVAILABLE) {
                    errorMessage += "\n\nFirefox: Pr√≥b√°ld a 'GPS K√©nyszer√≠t√©se' gombot, vagy ellen≈ërizd az about:config be√°ll√≠t√°sokat.";
                }
                
                document.getElementById('locationStatus').textContent = "HIBA";
                document.getElementById('coordinates').textContent = "-";
                document.getElementById('accuracyFill').style.width = "0%";
                document.getElementById('accuracyText').textContent = "-";
                
                showPositionError(errorMessage);
                
                if (!userLatLng && map) {
                    userLatLng = [47.4979, 19.0402];
                    userMarker = L.marker(userLatLng, {
                        icon: L.divIcon({
                            className: 'user-location-icon',
                            html: '<div style="background-color:#3498db;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>',
                            iconSize: [26, 26],
                            iconAnchor: [13, 13]
                        })
                    }).addTo(map);
                    userMarker.bindTooltip("Alap√©rtelmezett poz√≠ci√≥", {permanent: false, direction: 'top'}).openTooltip();
                }
                
                const statusElement = document.querySelector('.position-status');
                statusElement.classList.remove('high-accuracy', 'medium-accuracy', 'low-accuracy');
                statusElement.classList.add('inactive');
                document.getElementById('gpsTypeBadge').style.display = 'none';
            }
        }
        
        // ========== NMEA PARSER CLASS ==========
        
        class NMEAParser {
            constructor() {
                this.lastValidData = null;
                this.satellites = 0;
            }
            
            parseSentence(sentence) {
                if (!sentence || sentence.length < 6) return null;
                
                if (!sentence.startsWith('$') || sentence.indexOf('*') === -1) return null;
                
                const sentenceType = sentence.substring(3, 6);
                
                switch(sentenceType) {
                    case 'GGA':
                        return this.parseGGA(sentence);
                    case 'RMC':
                        return this.parseRMC(sentence);
                    case 'GSA':
                        return this.parseGSA(sentence);
                    case 'GSV':
                        return this.parseGSV(sentence);
                    default:
                        return null;
                }
            }
            
            parseGGA(sentence) {
                const parts = sentence.split(',');
                if (parts.length < 15) return null;
                
                try {
                    const lat = parts[2];
                    const latDir = parts[3];
                    const lon = parts[4];
                    const lonDir = parts[5];
                    const satellites = parseInt(parts[7]);
                    const hdop = parseFloat(parts[8]);
                    const altitude = parseFloat(parts[9]);
                    
                    const latDecimal = this.convertToDecimal(lat, latDir);
                    const lonDecimal = this.convertToDecimal(lon, lonDir);
                    
                    if (isNaN(latDecimal) || isNaN(lonDecimal)) return null;
                    
                    this.satellites = satellites;
                    
                    return {
                        type: 'GGA',
                        latitude: latDecimal,
                        longitude: lonDecimal,
                        satellites: satellites,
                        hdop: hdop,
                        altitude: altitude,
                        accuracy: hdop * 5
                    };
                } catch (e) {
                    console.error('Error parsing GGA:', e);
                    return null;
                }
            }
            
            parseRMC(sentence) {
                const parts = sentence.split(',');
                if (parts.length < 12) return null;
                
                try {
                    const status = parts[2];
                    const lat = parts[3];
                    const latDir = parts[4];
                    const lon = parts[5];
                    const lonDir = parts[6];
                    const speed = parseFloat(parts[7]);
                    const course = parseFloat(parts[8]);
                    
                    if (status !== 'A') return null;
                    
                    const latDecimal = this.convertToDecimal(lat, latDir);
                    const lonDecimal = this.convertToDecimal(lon, lonDir);
                    
                    if (isNaN(latDecimal) || isNaN(lonDecimal)) return null;
                    
                    return {
                        type: 'RMC',
                        latitude: latDecimal,
                        longitude: lonDecimal,
                        speed: speed,
                        course: course,
                        status: status
                    };
                } catch (e) {
                    console.error('Error parsing RMC:', e);
                    return null;
                }
            }
            
            parseGSA(sentence) {
                const parts = sentence.split(',');
                if (parts.length < 18) return null;
                
                try {
                    const satellites = [];
                    
                    for (let i = 3; i < 15; i++) {
                        if (parts[i] && parts[i] !== '') {
                            satellites.push(parseInt(parts[i]));
                        }
                    }
                    
                    const hdop = parseFloat(parts[16]);
                    
                    this.satellites = satellites.length;
                    
                    return {
                        type: 'GSA',
                        satellites: satellites,
                        hdop: hdop
                    };
                } catch (e) {
                    console.error('Error parsing GSA:', e);
                    return null;
                }
            }
            
            parseGSV(sentence) {
                const parts = sentence.split(',');
                if (parts.length < 7) return null;
                
                try {
                    const satellitesInView = parseInt(parts[3]);
                    
                    this.satellites = satellitesInView;
                    
                    return {
                        type: 'GSV',
                        satellitesInView: satellitesInView
                    };
                } catch (e) {
                    console.error('Error parsing GSV:', e);
                    return null;
                }
            }
            
            convertToDecimal(coord, direction) {
                if (!coord || coord === '') return NaN;
                
                const deg = Math.floor(parseFloat(coord) / 100);
                const min = parseFloat(coord) - (deg * 100);
                const decimal = deg + (min / 60);
                
                if (direction === 'S' || direction === 'W') {
                    return -decimal;
                }
                return decimal;
            }
            
            getSatelliteCount() {
                return this.satellites;
            }
        }
        
        // ========== BLUETOOTH GPS FUNCTIONS ==========
        
        async function scanBluetoothDevices() {
            try {
                if (!navigator.bluetooth) {
                    throw new Error('A b√∂ng√©sz≈ë nem t√°mogatja a Bluetooth Web API-t. Pr√≥b√°ld Chrome vagy Edge b√∂ng√©sz≈ët.');
                }
                
                updateBluetoothStatus('scanning', 'Eszk√∂z√∂k keres√©se...');
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['0000181a-0000-1000-8000-00805f9b34fb'] },
                        { services: ['0000181f-0000-1000-8000-00805f9b34fb'] },
                        { namePrefix: 'GPS' },
                        { namePrefix: 'BT' }
                    ],
                    optionalServices: [
                        '0000ffe0-0000-1000-8000-00805f9b34fb',
                        '0000ff00-0000-1000-8000-00805f9b34fb'
                    ]
                });
                
                bluetoothDevice = device;
                await connectBluetoothDevice(device);
                
            } catch (error) {
                console.error('Bluetooth hiba:', error);
                
                if (error.name === 'NotFoundError') {
                    updateBluetoothStatus('disconnected', 'Nincsenek el√©rhet≈ë Bluetooth GPS eszk√∂z√∂k');
                } else if (error.name === 'SecurityError') {
                    updateBluetoothStatus('disconnected', 'Bluetooth enged√©ly megtagadva');
                } else if (error.name === 'NotAllowedError') {
                    updateBluetoothStatus('disconnected', 'Felhaszn√°l√≥ megtagadta a Bluetooth hozz√°f√©r√©st');
                } else {
                    updateBluetoothStatus('disconnected', `Bluetooth hiba: ${error.message}`);
                }
            }
        }
        
        async function connectBluetoothDevice(device) {
            try {
                updateBluetoothStatus('scanning', 'Csatlakoz√°s...');
                
                device.addEventListener('gattserverdisconnected', onBluetoothDisconnected);
                
                const server = await device.gatt.connect();
                updateBluetoothStatus('scanning', 'Szolg√°ltat√°sok keres√©se...');
                
                const services = await server.getPrimaryServices();
                let foundCharacteristic = null;
                
                for (const service of services) {
                    try {
                        const characteristics = await service.getCharacteristics();
                        
                        for (const characteristic of characteristics) {
                            if (characteristic.properties.notify || characteristic.properties.read) {
                                foundCharacteristic = characteristic;
                                break;
                            }
                        }
                        
                        if (foundCharacteristic) break;
                    } catch (e) {
                        console.log(`Service ${service.uuid} error:`, e);
                    }
                }
                
                if (!foundCharacteristic) {
                    throw new Error('Nem tal√°lhat√≥ olvashat√≥ karakterisztika');
                }
                
                bluetoothCharacteristic = foundCharacteristic;
                
                if (bluetoothCharacteristic.properties.notify) {
                    await bluetoothCharacteristic.startNotifications();
                    bluetoothCharacteristic.addEventListener('characteristicvaluechanged', handleBluetoothData);
                    updateBluetoothStatus('connected', `Csatlakozva: ${device.name || 'Ismeretlen eszk√∂z'}`);
                    startBluetoothReading();
                } else if (bluetoothCharacteristic.properties.read) {
                    updateBluetoothStatus('connected', `Csatlakozva (polling m√≥d): ${device.name || 'Ismeretlen eszk√∂z'}`);
                    startBluetoothPolling();
                }
                
                document.getElementById('nmeaContainer').style.display = 'block';
                startBluetoothReconnectMonitor();
                
            } catch (error) {
                console.error('Csatlakoz√°si hiba:', error);
                updateBluetoothStatus('disconnected', `Csatlakoz√°si hiba: ${error.message}`);
            }
        }
        
        function handleBluetoothData(event) {
            const value = event.target.value;
            
            let dataString = '';
            if (value) {
                try {
                    dataString = new TextDecoder().decode(value);
                } catch (e) {
                    dataString = String.fromCharCode.apply(null, new Uint8Array(value.buffer));
                }
                
                processNMEAData(dataString);
            }
        }
        
        async function startBluetoothReading() {
            try {
                const value = await bluetoothCharacteristic.readValue();
                handleBluetoothData({ target: { value: value } });
            } catch (error) {
                console.log('Kezdeti olvas√°si hiba:', error);
            }
        }
        
        function startBluetoothPolling() {
            setInterval(async () => {
                try {
                    if (bluetoothCharacteristic && bluetoothCharacteristic.properties.read) {
                        const value = await bluetoothCharacteristic.readValue();
                        handleBluetoothData({ target: { value: value } });
                    }
                } catch (error) {
                    console.log('Polling hiba:', error);
                }
            }, 1000);
        }
        
        function processNMEAData(dataString) {
            if (!nmeaParser) {
                nmeaParser = new NMEAParser();
            }
            
            const lines = dataString.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                updateNMEADisplay(line);
                
                const parsedData = nmeaParser.parseSentence(line);
                
                if (parsedData) {
                    satelliteCount = nmeaParser.getSatelliteCount();
                    updateSatelliteDisplay();
                    
                    if (parsedData.latitude && parsedData.longitude) {
                        const accuracy = parsedData.accuracy || 
                                       (parsedData.hdop ? parsedData.hdop * 5 : 50);
                        
                        const mockPosition = {
                            coords: {
                                latitude: parsedData.latitude,
                                longitude: parsedData.longitude,
                                accuracy: accuracy,
                                altitude: parsedData.altitude || null,
                                altitudeAccuracy: null,
                                heading: parsedData.course || null,
                                speed: parsedData.speed ? parsedData.speed * 0.514444 : null
                            },
                            timestamp: Date.now()
                        };
                        
                        processPosition(mockPosition);
                    }
                }
            }
        }
        
        function updateNMEADisplay(line) {
            const nmeaDataElement = document.getElementById('nmeaData');
            const lines = nmeaDataElement.textContent.split('\n');
            
            lines.unshift(line);
            
            if (lines.length > 10) {
                lines.pop();
            }
            
            nmeaDataElement.textContent = lines.join('\n');
            nmeaDataElement.scrollTop = 0;
        }
        
        function updateSatelliteDisplay() {
            const satelliteElement = document.getElementById('satelliteCount');
            satelliteElement.textContent = satelliteCount;
            
            const signalBars = document.querySelectorAll('.signal-bar');
            const barCount = Math.min(satelliteCount, 5);
            
            signalBars.forEach((bar, index) => {
                if (index < barCount) {
                    if (satelliteCount >= 8) {
                        bar.className = 'signal-bar active';
                    } else if (satelliteCount >= 5) {
                        bar.className = 'signal-bar medium';
                    } else {
                        bar.className = 'signal-bar weak';
                    }
                } else {
                    bar.className = 'signal-bar';
                }
            });
        }
        
        function onBluetoothDisconnected() {
            console.log('Bluetooth eszk√∂z lev√°lasztva');
            updateBluetoothStatus('disconnected', 'Bluetooth eszk√∂z lev√°lasztva');
            
            document.getElementById('nmeaData').textContent = '';
            document.getElementById('nmeaContainer').style.display = 'none';
            
            stopBluetoothReconnectMonitor();
            
            if (gpsSource === 'bluetooth') {
                switchToInternalGPS();
            }
        }
        
        function disconnectBluetooth() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
            
            bluetoothDevice = null;
            bluetoothCharacteristic = null;
            nmeaParser = null;
            
            updateBluetoothStatus('disconnected', 'Kapcsolat n√©lk√ºl');
            document.getElementById('nmeaContainer').style.display = 'none';
            
            stopBluetoothReconnectMonitor();
        }
        
        function updateBluetoothStatus(status, message) {
            const statusElement = document.getElementById('bluetoothStatus');
            const scanBtn = document.getElementById('bluetoothScanBtn');
            
            statusElement.textContent = `Bluetooth: ${message}`;
            statusElement.className = `bluetooth-status ${status}`;
            scanBtn.className = `bluetooth-btn ${status}`;
            
            if (status === 'connected') {
                scanBtn.innerHTML = '<span class="icon">üîå</span> Kapcsolat Bont√°sa';
            } else if (status === 'scanning') {
                scanBtn.innerHTML = '<span class="icon">‚è≥</span> Keres√©s...';
            } else {
                scanBtn.innerHTML = '<span class="icon">üîç</span> Eszk√∂z√∂k Keres√©se';
            }
        }
        
        function startBluetoothReconnectMonitor() {
            bluetoothReconnectInterval = setInterval(() => {
                if (bluetoothDevice && !bluetoothDevice.gatt.connected && gpsSource === 'bluetooth') {
                    console.log('√öjracsatlakoz√°s k√≠s√©rlet...');
                    updateBluetoothStatus('scanning', '√öjracsatlakoz√°s...');
                    
                    connectBluetoothDevice(bluetoothDevice).catch(error => {
                        console.log('√öjracsatlakoz√°si hiba:', error);
                    });
                }
            }, 5000);
        }
        
        function stopBluetoothReconnectMonitor() {
            if (bluetoothReconnectInterval) {
                clearInterval(bluetoothReconnectInterval);
                bluetoothReconnectInterval = null;
            }
        }
        
        // ========== GPS SOURCE SWITCHING ==========
        
        function switchToInternalGPS() {
            gpsSource = 'internal';
            
            document.getElementById('sourceInternal').classList.add('active');
            document.getElementById('sourceBluetooth').classList.remove('active');
            document.getElementById('bluetoothSection').style.display = 'none';
            
            console.log('√Åtv√°lt√°s bels≈ë GPS-re');
            
            stopPositionTracking();
            setTimeout(() => {
                if (isFirefox) {
                    startFirefoxPositionTracking();
                } else {
                    startNormalPositionTracking();
                }
            }, 100);
            
            document.getElementById('gpsTypeBadge').textContent = 'GPS';
            document.getElementById('gpsTypeBadge').className = 'gps-type gps-high';
            document.getElementById('locationStatus').textContent = "Bels≈ë GPS akt√≠v";
        }
        
        function switchToBluetoothGPS() {
            if (!bluetoothDevice || !bluetoothDevice.gatt.connected) {
                alert('El≈ësz√∂r csatlakozz egy Bluetooth GPS eszk√∂zh√∂z!');
                document.getElementById('sourceInternal').classList.add('active');
                document.getElementById('sourceBluetooth').classList.remove('active');
                return;
            }
            
            gpsSource = 'bluetooth';
            
            document.getElementById('sourceInternal').classList.remove('active');
            document.getElementById('sourceBluetooth').classList.add('active');
            document.getElementById('bluetoothSection').style.display = 'block';
            
            stopPositionTracking();
            
            document.getElementById('gpsTypeBadge').textContent = 'BT GPS';
            document.getElementById('gpsTypeBadge').className = 'gps-type gps-high';
            document.getElementById('locationStatus').textContent = "Bluetooth GPS akt√≠v";
        }
        
        // ========== EXISTING APPLICATION FUNCTIONS ==========
        
        // B√∂ng√©sz≈ë detekt√°l√°s
        function detectBrowser() {
            const userAgent = navigator.userAgent;
            
            if (userAgent.indexOf("Firefox") > -1) {
                isFirefox = true;
                document.getElementById('browserInfo').textContent = "B√∂ng√©sz≈ë: Firefox";
                document.getElementById('firefoxOptimization').style.display = 'block';
                document.getElementById('locationStatus').textContent = "Firefox √©szlelve - GPS optimaliz√°l√°s...";
            } else if (userAgent.indexOf("Chrome") > -1) {
                document.getElementById('browserInfo').textContent = "B√∂ng√©sz≈ë: Chrome";
                document.getElementById('locationStatus').textContent = "Chrome √©szlelve - Teljes GPS t√°mogat√°s";
            } else {
                document.getElementById('browserInfo').textContent = `B√∂ng√©sz≈ë: ${userAgent.split(' ')[0]}`;
            }
        }
        
        // Pontoss√°g √°llapot friss√≠t√©se
        function updateAccuracyStatus(accuracy) {
            const accuracyFill = document.getElementById('accuracyFill');
            const accuracyText = document.getElementById('accuracyText');
            const statusElement = document.querySelector('.position-status');
            const gpsTypeBadge = document.getElementById('gpsTypeBadge');
            
            accuracyHistory.push(accuracy);
            if (accuracyHistory.length > 10) {
                accuracyHistory.shift();
            }
            
            let accuracyPercent;
            if (accuracy <= 10) {
                accuracyPercent = 100;
            } else if (accuracy <= 50) {
                accuracyPercent = 80;
            } else if (accuracy <= 100) {
                accuracyPercent = 60;
            } else if (accuracy <= 500) {
                accuracyPercent = 40;
            } else {
                accuracyPercent = 20;
            }
            
            accuracyFill.style.width = `${accuracyPercent}%`;
            accuracyText.textContent = `${accuracy.toFixed(1)} m`;
            
            statusElement.classList.remove('high-accuracy', 'medium-accuracy', 'low-accuracy', 'inactive');
            
            if (accuracy <= 20) {
                statusElement.classList.add('high-accuracy');
                accuracyText.className = 'accuracy-text high-accuracy-text';
                gpsTypeBadge.textContent = 'GPS';
                gpsTypeBadge.className = 'gps-type gps-high';
                gpsTypeBadge.style.display = 'inline';
                document.getElementById('locationStatus').textContent = "Magas pontoss√°g√∫ GPS";
            } else if (accuracy <= 100) {
                statusElement.classList.add('medium-accuracy');
                accuracyText.className = 'accuracy-text medium-accuracy-text';
                gpsTypeBadge.textContent = 'H√ÅL√ìZAT';
                gpsTypeBadge.className = 'gps-type gps-medium';
                gpsTypeBadge.style.display = 'inline';
                document.getElementById('locationStatus').textContent = "K√∂zepes pontoss√°g (h√°l√≥zat)";
            } else {
                statusElement.classList.add('low-accuracy');
                accuracyText.className = 'accuracy-text low-accuracy-text';
                gpsTypeBadge.textContent = 'BECSL√âS';
                gpsTypeBadge.className = 'gps-type gps-low';
                gpsTypeBadge.style.display = 'inline';
                document.getElementById('locationStatus').textContent = "Alacsony pontoss√°g (becsl√©s)";
            }
            
            if (isFirefox && accuracy > 50) {
                document.getElementById('firefoxOptimization').style.display = 'block';
            }
        }
        
        // Hiba√ºzenet megjelen√≠t√©se
        function showPositionError(message) {
            const errorElement = document.getElementById('positionError');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        // Hiba√ºzenet elrejt√©se
        function hidePositionError() {
            document.getElementById('positionError').style.display = 'none';
        }
        
        // Firefox GPS pontoss√°g jav√≠t√≥ megold√°s
        function startFirefoxPositionTracking() {
            console.log("Firefox GPS optimaliz√°lt k√∂vet√©s ind√≠t√°sa");
            
            try {
                watchId = navigator.geolocation.watchPosition(
                    position => {
                        processPosition(position);
                    },
                    error => {
                        handlePositionError(error);
                        if (isFirefox) {
                            setTimeout(startNormalPositionTracking, 1000);
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 30000
                    }
                );
                
                setInterval(() => {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            processPosition(position);
                        },
                        error => console.log("Firefox polling hiba:", error),
                        {
                            enableHighAccuracy: true,
                            maximumAge: 0,
                            timeout: 10000
                        }
                    );
                }, 2000);
                
            } catch (error) {
                console.error("Firefox extr√©m m√≥d hiba:", error);
                startNormalPositionTracking();
            }
        }
        
        // Norm√°l poz√≠ci√≥ k√∂vet√©s
        function startNormalPositionTracking() {
            console.log("Norm√°l poz√≠ci√≥ k√∂vet√©s ind√≠t√°sa");
            
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
            }
            
            watchId = navigator.geolocation.watchPosition(
                position => {
                    processPosition(position);
                },
                handlePositionError,
                {
                    enableHighAccuracy: true,
                    maximumAge: 1000,
                    timeout: 10000
                }
            );
        }
        
        // GPS k√©nyszer√≠t√©se
        function forceGpsTracking() {
            console.log("GPS K√âNYSZER√çT√âS aktiv√°lva");
            forceGpsMode = true;
            
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            const gpsOptions = [
                { enableHighAccuracy: true, maximumAge: 0, timeout: 30000 },
                { enableHighAccuracy: true, maximumAge: 0, timeout: 60000 },
                { enableHighAccuracy: false, maximumAge: 0, timeout: 30000 },
            ];
            
            let attempt = 0;
            
            function tryNextOption() {
                if (attempt >= gpsOptions.length) {
                    console.log("Minden GPS opci√≥ kipr√≥b√°lva, vissza norm√°l m√≥d");
                    forceGpsMode = false;
                    startNormalPositionTracking();
                    return;
                }
                
                const options = gpsOptions[attempt];
                console.log(`GPS k√©nyszer√≠t√©s pr√≥ba ${attempt + 1}:`, options);
                
                watchId = navigator.geolocation.watchPosition(
                    position => {
                        console.log(`GPS k√©nyszer√≠t√©s ${attempt + 1} sikeres, pontoss√°g: ${position.coords.accuracy}m`);
                        processPosition(position);
                    },
                    error => {
                        console.log(`GPS k√©nyszer√≠t√©s ${attempt + 1} hiba:`, error);
                        attempt++;
                        setTimeout(tryNextOption, 1000);
                    },
                    options
                );
                
                setTimeout(() => {
                    if (userLatLng === null) {
                        console.log(`GPS k√©nyszer√≠t√©s ${attempt + 1} id≈ët√∫ll√©p√©s`);
                        navigator.geolocation.clearWatch(watchId);
                        attempt++;
                        tryNextOption();
                    }
                }, 5000);
            }
            
            tryNextOption();
        }
        
        // ========== MAP AND APPLICATION INITIALIZATION ==========
        
        function initializeApplication() {
            // T√©rk√©p inicializ√°l√°sa - CSAK ha a DOM bet√∂lt√∂tt
            if (document.getElementById('map')) {
                map = L.map('map').setView([47.1625, 19.5033], 7);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(map);
                
                console.log("T√©rk√©p sikeresen inicializ√°lva");
            } else {
                console.error("Hiba: 'map' elem nem tal√°lhat√≥!");
                return;
            }
            
            // B√∂ng√©sz≈ë detekt√°l√°s
            detectBrowser();
            
            // Initialize NMEA parser
            nmeaParser = new NMEAParser();
            
            // Check Bluetooth availability
            if (!navigator.bluetooth) {
                document.getElementById('sourceBluetooth').disabled = true;
                document.getElementById('sourceBluetooth').title = "A b√∂ng√©sz≈ë nem t√°mogatja a Bluetooth-ot";
                document.getElementById('bluetoothSection').innerHTML += 
                    '<div class="error-message" style="margin-top: 10px;">A b√∂ng√©sz≈ë nem t√°mogatja a Bluetooth GPS-t. Haszn√°ld a Chrome vagy Edge b√∂ng√©sz≈ët.</div>';
            }
            
            // Start GPS tracking
            if (isFirefox) {
                startFirefoxPositionTracking();
            } else {
                startNormalPositionTracking();
            }
            
            // Minta poligon bet√∂lt√©se
            setTimeout(() => {
                if (map && !originalPolygons.length) {
                    const samplePolygon = L.polygon([
                        [47.5000, 19.0300],
                        [47.5100, 19.0300],
                        [47.5100, 19.0400],
                        [47.5000, 19.0400]
                    ], {
                        color: '#9b59b6',
                        weight: 2,
                        opacity: 0.7,
                        fillOpacity: 0.1
                    }).addTo(map);
                    
                    originalPolygons.push(samplePolygon);
                    samplePolygon.bindTooltip("Minta poligon (n√©gyzet)", {permanent: false, direction: 'top'});
                    
                    // Poligon sz√©tbont√°sa
                    const elements = decomposePolygon(samplePolygon, "Minta poligon (n√©gyzet)", 0);
                    polygonElements = polygonElements.concat(elements);
                    
                    updateElementsList();
                    filterElementsByMode('all');
                    
                    document.getElementById('fileName').textContent = "Bemutat√≥ n√©gyzet poligon";
                    document.getElementById('fileName').style.color = '#3498db';
                    
                    map.fitBounds(samplePolygon.getBounds().pad(0.2));
                }
            }, 1000);
            
            // Esem√©nykezel≈ëk be√°ll√≠t√°sa
            setupEventListeners();
        }
        
        // ========== EVENT LISTENERS SETUP ==========
        
        function setupEventListeners() {
            // GPS source selectors
            document.getElementById('sourceInternal').addEventListener('click', switchToInternalGPS);
            document.getElementById('sourceBluetooth').addEventListener('click', switchToBluetoothGPS);
            
            // Bluetooth scan button
            document.getElementById('bluetoothScanBtn').addEventListener('click', function() {
                if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                    disconnectBluetooth();
                } else {
                    scanBluetoothDevices();
                }
            });
            
            // Existing application event listeners
            document.getElementById('uploadBtn').addEventListener('click', function() {
                document.getElementById('kmlFile').click();
            });
            
            document.getElementById('kmlFile').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    if (file.name.toLowerCase().endsWith('.kml') || file.name.toLowerCase().endsWith('.xml')) {
                        loadKMLFile(file);
                        document.getElementById('uploadBtn').innerHTML = `<span class="icon">‚úÖ</span> F√°jl bet√∂ltve`;
                    } else {
                        alert("K√©rlek, csak KML vagy XML f√°jlokat t√∂lts fel!");
                        document.getElementById('kmlFile').value = '';
                        document.getElementById('fileName').textContent = "√ârv√©nytelen f√°jlt√≠pus";
                        document.getElementById('fileName').style.color = '#e74c3c';
                    }
                }
            });
            
            // M√≥dv√°laszt√≥ gombok
            document.getElementById('modeAll').addEventListener('click', () => filterElementsByMode('all'));
            document.getElementById('modeCorners').addEventListener('click', () => filterElementsByMode('corners'));
            document.getElementById('modeSides').addEventListener('click', () => filterElementsByMode('sides'));
            
            // Teljes k√©perny≈ës gombok
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            document.getElementById('headerFullscreenBtn').addEventListener('click', toggleFullscreen);
            
            // Oldals√°v v√°lt√≥ gombok
            document.getElementById('toggleSidebarBtn').addEventListener('click', toggleSidebar);
            document.getElementById('headerToggleSidebarBtn').addEventListener('click', toggleSidebar);
            
            // GPS k√©nyszer√≠t√©s gomb
            document.getElementById('forceGpsBtn').addEventListener('click', function() {
                console.log("GPS k√©nyszer√≠t√©s gomb megnyomva");
                document.getElementById('locationStatus').textContent = "GPS k√©nyszer√≠t√©s aktiv√°lva...";
                forceGpsTracking();
            });
            
            // Poz√≠ci√≥ √∫jraind√≠t√°s gomb
            document.getElementById('resetPositionBtn').addEventListener('click', function() {
                console.log("Poz√≠ci√≥ √∫jraind√≠t√°s");
                stopPositionTracking();
                accuracyHistory = [];
                setTimeout(() => {
                    if (isFirefox) {
                        startFirefoxPositionTracking();
                    } else {
                        startNormalPositionTracking();
                    }
                }, 100);
            });
            
            // Billenty≈±zet parancsok
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreen();
                }
                if (e.key === 'Escape' && isFullscreen) {
                    toggleFullscreen();
                }
                if (e.key === ' ') {
                    e.preventDefault();
                    toggleSidebar();
                }
                if (e.key === 'r' || e.key === 'R') {
                    e.preventDefault();
                    document.getElementById('resetPositionBtn').click();
                }
                if (e.key === 'g' || e.key === 'G') {
                    e.preventDefault();
                    document.getElementById('forceGpsBtn').click();
                }
            });
            
            // Oldal l√°that√≥s√°g v√°ltoz√°sakor
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    setTimeout(() => {
                        if (isFirefox) {
                            startFirefoxPositionTracking();
                        } else {
                            startNormalPositionTracking();
                        }
                    }, 500);
                }
            });
        }
        
        // ========== EXISTING APPLICATION FUNCTIONS (CONTINUED) ==========
        
        // [ADD ALL THE REMAINING FUNCTIONS FROM YOUR ORIGINAL CODE HERE]
        // These include: calculateDistance, pointToInfiniteLineDistance, extendLine,
        // drawMeasurementLine, drawExtendedLine, decomposePolygon, handleElementClick,
        // updateMeasurement, resetElementStyle, highlightElement, parseKML, clearAllLayers,
        // updateElementsList, updateElementsListSelection, filterElementsByMode,
        // updateElementCount, loadKMLFile, toggleFullscreen, toggleSidebar, etc.
        
        // Make sure to copy ALL the remaining functions from your original code
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            stopPositionTracking();
            disconnectBluetooth();
        });
        
        // ========== INITIALIZE WHEN DOM IS LOADED ==========
        
        document.addEventListener('DOMContentLoaded', initializeApplication);
        
    </script>
</body>
</html>
