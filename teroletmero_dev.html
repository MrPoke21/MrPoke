<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KML Poligon Elemz≈ë √©s M√©r≈ë</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* ... (existing CSS styles remain the same) ... */
        
        /* Bluetooth specific styles */
        .bluetooth-section {
            background-color: #f0f8ff;
            padding: 1.2rem;
            border-radius: 8px;
            border-left: 4px solid #4a6fa5;
            margin-top: 1rem;
        }
        
        .bluetooth-controls {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-top: 0.8rem;
        }
        
        .bluetooth-btn {
            background-color: #4a6fa5;
            color: white;
            border: none;
            padding: 0.7rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.3s;
        }
        
        .bluetooth-btn:hover {
            background-color: #3a5a8a;
        }
        
        .bluetooth-btn.disconnected {
            background-color: #95a5a6;
        }
        
        .bluetooth-btn.connected {
            background-color: #2ecc71;
        }
        
        .bluetooth-btn.scanning {
            background-color: #f39c12;
            animation: pulse-scanning 1.5s infinite;
        }
        
        @keyframes pulse-scanning {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .bluetooth-status {
            font-size: 0.9rem;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
        }
        
        .bluetooth-status.connected {
            background-color: #d5f4e6;
            color: #27ae60;
            border: 1px solid #2ecc71;
        }
        
        .bluetooth-status.disconnected {
            background-color: #fadbd8;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .bluetooth-status.scanning {
            background-color: #fef9e7;
            color: #f39c12;
            border: 1px solid #f39c12;
        }
        
        .device-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            background-color: white;
        }
        
        .device-item {
            padding: 0.6rem;
            margin-bottom: 0.3rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .device-item:hover {
            background-color: #e9ecef;
        }
        
        .device-item.selected {
            background-color: #e8f4fc;
            border-left: 3px solid #3498db;
        }
        
        .device-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .device-id {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .nmea-data {
            font-family: monospace;
            font-size: 0.8rem;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 0.5rem;
            border-radius: 4px;
            overflow-x: auto;
            white-space: nowrap;
            margin-top: 0.5rem;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .gps-source-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.8rem;
        }
        
        .source-btn {
            flex: 1;
            padding: 0.6rem;
            border: 2px solid #ddd;
            background-color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .source-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .source-btn.internal {
            border-color: #2ecc71;
        }
        
        .source-btn.internal.active {
            background-color: #2ecc71;
            border-color: #2ecc71;
        }
        
        .source-btn.bluetooth {
            border-color: #4a6fa5;
        }
        
        .source-btn.bluetooth.active {
            background-color: #4a6fa5;
            border-color: #4a6fa5;
        }
        
        .satellite-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        .satellite-count {
            background-color: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }
        
        .signal-strength {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .signal-bar {
            width: 12px;
            height: 4px;
            background-color: #ddd;
            border-radius: 2px;
        }
        
        .signal-bar.active {
            background-color: #2ecc71;
        }
        
        .signal-bar.medium {
            background-color: #f39c12;
        }
        
        .signal-bar.weak {
            background-color: #e74c3c;
        }
    </style>
</head>
<body>
    <!-- ... (existing HTML remains the same) ... -->
    
    <div class="sidebar">
        <div class="control-panel">
            <h2 class="section-title">GPS Forr√°s V√°laszt√°sa</h2>
            <div class="gps-source-selector">
                <button id="sourceInternal" class="source-btn internal active">Bels≈ë GPS</button>
                <button id="sourceBluetooth" class="source-btn bluetooth">Bluetooth GPS</button>
            </div>
            
            <!-- Bluetooth GPS Section (initially hidden) -->
            <div id="bluetoothSection" class="bluetooth-section" style="display: none;">
                <div class="info-title">
                    <span class="icon">üì°</span>
                    Bluetooth GPS
                </div>
                
                <div class="bluetooth-controls">
                    <button id="bluetoothScanBtn" class="bluetooth-btn">
                        <span class="icon">üîç</span>
                        Eszk√∂z√∂k Keres√©se
                    </button>
                    
                    <div id="bluetoothStatus" class="bluetooth-status disconnected">
                        Bluetooth: Kapcsolat n√©lk√ºl
                    </div>
                    
                    <div id="deviceList" class="device-list" style="display: none;">
                        <!-- Bluetooth eszk√∂z√∂k list√°ja -->
                    </div>
                    
                    <div id="nmeaContainer" style="display: none;">
                        <div class="info-title" style="margin-top: 0.5rem; font-size: 1rem;">
                            <span class="icon">üì°</span>
                            NMEA Adatok
                        </div>
                        <div id="nmeaData" class="nmea-data">
                            <!-- NMEA adatok jelennek meg itt -->
                        </div>
                        
                        <div class="satellite-info">
                            <span>M≈±holdak:</span>
                            <span id="satelliteCount" class="satellite-count">0</span>
                            <div class="signal-strength">
                                <div class="signal-bar"></div>
                                <div class="signal-bar"></div>
                                <div class="signal-bar"></div>
                                <div class="signal-bar"></div>
                                <div class="signal-bar"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <h2 class="section-title">KML F√°jl Bet√∂lt√©se</h2>
            <!-- ... (rest of existing HTML remains the same) ... -->
        </div>
    </div>

    <script>
        // ... (existing variables remain the same) ... 
        let gpsSource = 'internal'; // 'internal' or 'bluetooth'
        let bluetoothDevice = null;
        let bluetoothCharacteristic = null;
        let nmeaParser = null;
        let satelliteCount = 0;
        let bluetoothReconnectInterval = null;
        
        // ========== POSITION TRACKING FUNCTIONS (DEFINE THEM EARLY) ==========
        
        // Poz√≠ci√≥ k√∂vet√©s le√°ll√≠t√°sa
        function stopPositionTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            forceGpsMode = false;
        }
        
        // Poz√≠ci√≥ hiba kezel√©se
        function handlePositionError(error) {
            console.error("Helymeghat√°roz√°si hiba:", error);
            
            // Only show error if we're using internal GPS
            if (gpsSource === 'internal') {
                let errorMessage = "Hiba: ";
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += "Hozz√°f√©r√©s megtagadva. Enged√©lyezd a helymeghat√°roz√°st!";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += "Helyinform√°ci√≥ nem el√©rhet≈ë. Ellen≈ërizd a GPS-t!";
                        break;
                    case error.TIMEOUT:
                        errorMessage += "Id≈ët√∫ll√©p√©s. Pr√≥b√°ld √∫jra!";
                        break;
                    default:
                        errorMessage += "Ismeretlen hiba.";
                        break;
                }
                
                // Firefox specifikus javaslat
                if (isFirefox && error.code === error.POSITION_UNAVAILABLE) {
                    errorMessage += "\n\nFirefox: Pr√≥b√°ld a 'GPS K√©nyszer√≠t√©se' gombot, vagy ellen≈ërizd az about:config be√°ll√≠t√°sokat.";
                }
                
                document.getElementById('locationStatus').textContent = "HIBA";
                document.getElementById('coordinates').textContent = "-";
                document.getElementById('accuracyFill').style.width = "0%";
                document.getElementById('accuracyText').textContent = "-";
                
                showPositionError(errorMessage);
                
                // Alap√©rtelmezett poz√≠ci√≥ (Budapest) be√°ll√≠t√°sa hiba eset√©n
                if (!userLatLng) {
                    userLatLng = [47.4979, 19.0402];
                    userMarker = L.marker(userLatLng, {
                        icon: L.divIcon({
                            className: 'user-location-icon',
                            html: '<div style="background-color:#3498db;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>',
                            iconSize: [26, 26],
                            iconAnchor: [13, 13]
                        })
                    }).addTo(map);
                    userMarker.bindTooltip("Alap√©rtelmezett poz√≠ci√≥", {permanent: false, direction: 'top'}).openTooltip();
                }
                
                const statusElement = document.querySelector('.position-status');
                statusElement.classList.remove('high-accuracy', 'medium-accuracy', 'low-accuracy');
                statusElement.classList.add('inactive');
                document.getElementById('gpsTypeBadge').style.display = 'none';
            }
        }
        
        // ========== NMEA PARSER CLASS ==========
        
        class NMEAParser {
            constructor() {
                this.lastValidData = null;
                this.satellites = 0;
            }
            
            parseSentence(sentence) {
                if (!sentence || sentence.length < 6) return null;
                
                // Check if sentence starts with $ and ends with *
                if (!sentence.startsWith('$') || sentence.indexOf('*') === -1) return null;
                
                // Basic checksum verification
                const checksumIndex = sentence.indexOf('*');
                const data = sentence.substring(1, checksumIndex);
                const checksum = sentence.substring(checksumIndex + 1);
                
                // Parse different NMEA sentence types
                const sentenceType = sentence.substring(3, 6);
                
                switch(sentenceType) {
                    case 'GGA': // Global Positioning System Fix Data
                        return this.parseGGA(sentence);
                    case 'RMC': // Recommended Minimum Specific GPS/Transit Data
                        return this.parseRMC(sentence);
                    case 'GSA': // GPS DOP and active satellites
                        return this.parseGSA(sentence);
                    case 'GSV': // GPS Satellites in view
                        return this.parseGSV(sentence);
                    default:
                        return null;
                }
            }
            
            parseGGA(sentence) {
                const parts = sentence.split(',');
                if (parts.length < 15) return null;
                
                try {
                    const time = parts[1];
                    const lat = parts[2];
                    const latDir = parts[3];
                    const lon = parts[4];
                    const lonDir = parts[5];
                    const fixQuality = parseInt(parts[6]);
                    const satellites = parseInt(parts[7]);
                    const hdop = parseFloat(parts[8]);
                    const altitude = parseFloat(parts[9]);
                    const altitudeUnit = parts[10];
                    
                    // Convert lat/lon to decimal degrees
                    const latDecimal = this.convertToDecimal(lat, latDir);
                    const lonDecimal = this.convertToDecimal(lon, lonDir);
                    
                    if (isNaN(latDecimal) || isNaN(lonDecimal)) return null;
                    
                    this.satellites = satellites;
                    
                    return {
                        type: 'GGA',
                        time: time,
                        latitude: latDecimal,
                        longitude: lonDecimal,
                        fixQuality: fixQuality,
                        satellites: satellites,
                        hdop: hdop,
                        altitude: altitude,
                        altitudeUnit: altitudeUnit,
                        accuracy: hdop * 5 // Approximate accuracy in meters
                    };
                } catch (e) {
                    console.error('Error parsing GGA:', e);
                    return null;
                }
            }
            
            parseRMC(sentence) {
                const parts = sentence.split(',');
                if (parts.length < 12) return null;
                
                try {
                    const time = parts[1];
                    const status = parts[2];
                    const lat = parts[3];
                    const latDir = parts[4];
                    const lon = parts[5];
                    const lonDir = parts[6];
                    const speed = parseFloat(parts[7]);
                    const course = parseFloat(parts[8]);
                    const date = parts[9];
                    
                    if (status !== 'A') return null; // Invalid fix
                    
                    const latDecimal = this.convertToDecimal(lat, latDir);
                    const lonDecimal = this.convertToDecimal(lon, lonDir);
                    
                    if (isNaN(latDecimal) || isNaN(lonDecimal)) return null;
                    
                    return {
                        type: 'RMC',
                        time: time,
                        date: date,
                        latitude: latDecimal,
                        longitude: lonDecimal,
                        speed: speed,
                        course: course,
                        status: status
                    };
                } catch (e) {
                    console.error('Error parsing RMC:', e);
                    return null;
                }
            }
            
            parseGSA(sentence) {
                const parts = sentence.split(',');
                if (parts.length < 18) return null;
                
                try {
                    const mode = parts[1];
                    const fixType = parseInt(parts[2]);
                    const satellites = [];
                    
                    for (let i = 3; i < 15; i++) {
                        if (parts[i] && parts[i] !== '') {
                            satellites.push(parseInt(parts[i]));
                        }
                    }
                    
                    const pdop = parseFloat(parts[15]);
                    const hdop = parseFloat(parts[16]);
                    const vdop = parseFloat(parts[17]);
                    
                    this.satellites = satellites.length;
                    
                    return {
                        type: 'GSA',
                        mode: mode,
                        fixType: fixType,
                        satellites: satellites,
                        pdop: pdop,
                        hdop: hdop,
                        vdop: vdop
                    };
                } catch (e) {
                    console.error('Error parsing GSA:', e);
                    return null;
                }
            }
            
            parseGSV(sentence) {
                // GSV sentences contain satellite information
                const parts = sentence.split(',');
                if (parts.length < 7) return null;
                
                try {
                    const totalMessages = parseInt(parts[1]);
                    const messageNumber = parseInt(parts[2]);
                    const satellitesInView = parseInt(parts[3]);
                    
                    this.satellites = satellitesInView;
                    
                    return {
                        type: 'GSV',
                        totalMessages: totalMessages,
                        messageNumber: messageNumber,
                        satellitesInView: satellitesInView
                    };
                } catch (e) {
                    console.error('Error parsing GSV:', e);
                    return null;
                }
            }
            
            convertToDecimal(coord, direction) {
                if (!coord || coord === '') return NaN;
                
                // Format: DDMM.MMMMM or DDDMM.MMMMM
                const deg = Math.floor(parseFloat(coord) / 100);
                const min = parseFloat(coord) - (deg * 100);
                const decimal = deg + (min / 60);
                
                // Apply direction
                if (direction === 'S' || direction === 'W') {
                    return -decimal;
                }
                return decimal;
            }
            
            getSatelliteCount() {
                return this.satellites;
            }
        }
        
        // ========== BLUETOOTH GPS FUNCTIONS ==========
        
        async function scanBluetoothDevices() {
            try {
                if (!navigator.bluetooth) {
                    throw new Error('A b√∂ng√©sz≈ë nem t√°mogatja a Bluetooth Web API-t. Pr√≥b√°ld Chrome vagy Edge b√∂ng√©sz≈ët.');
                }
                
                updateBluetoothStatus('scanning', 'Eszk√∂z√∂k keres√©se...');
                
                // Request Bluetooth device with GPS service
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['0000181a-0000-1000-8000-00805f9b34fb'] }, // Environmental Sensing (common for GPS)
                        { services: ['0000181f-0000-1000-8000-00805f9b34fb'] }, // Location and Navigation
                        { services: ['00001816-0000-1000-8000-00805f9b34fb'] }, // Cycling Speed and Cadence (sometimes GPS)
                        { namePrefix: 'GPS' },
                        { namePrefix: 'BT' }
                    ],
                    optionalServices: [
                        '0000ffe0-0000-1000-8000-00805f9b34fb', // Common for serial over Bluetooth
                        '0000ff00-0000-1000-8000-00805f9b34fb'  // Another common service
                    ]
                });
                
                bluetoothDevice = device;
                await connectBluetoothDevice(device);
                
            } catch (error) {
                console.error('Bluetooth hiba:', error);
                
                if (error.name === 'NotFoundError') {
                    updateBluetoothStatus('disconnected', 'Nincsenek el√©rhet≈ë Bluetooth GPS eszk√∂z√∂k');
                } else if (error.name === 'SecurityError') {
                    updateBluetoothStatus('disconnected', 'Bluetooth enged√©ly megtagadva');
                } else if (error.name === 'NotAllowedError') {
                    updateBluetoothStatus('disconnected', 'Felhaszn√°l√≥ megtagadta a Bluetooth hozz√°f√©r√©st');
                } else {
                    updateBluetoothStatus('disconnected', `Bluetooth hiba: ${error.message}`);
                }
            }
        }
        
        async function connectBluetoothDevice(device) {
            try {
                updateBluetoothStatus('scanning', 'Csatlakoz√°s...');
                
                device.addEventListener('gattserverdisconnected', onBluetoothDisconnected);
                
                const server = await device.gatt.connect();
                updateBluetoothStatus('scanning', 'Szolg√°ltat√°sok keres√©se...');
                
                // Try to find services and characteristics
                const services = await server.getPrimaryServices();
                
                let foundCharacteristic = null;
                
                for (const service of services) {
                    try {
                        const characteristics = await service.getCharacteristics();
                        
                        for (const characteristic of characteristics) {
                            // Look for characteristics that support notify or read
                            if (characteristic.properties.notify || characteristic.properties.read) {
                                foundCharacteristic = characteristic;
                                break;
                            }
                        }
                        
                        if (foundCharacteristic) break;
                    } catch (e) {
                        console.log(`Service ${service.uuid} error:`, e);
                    }
                }
                
                if (!foundCharacteristic) {
                    throw new Error('Nem tal√°lhat√≥ olvashat√≥ karakterisztika');
                }
                
                bluetoothCharacteristic = foundCharacteristic;
                
                // Enable notifications if available
                if (bluetoothCharacteristic.properties.notify) {
                    await bluetoothCharacteristic.startNotifications();
                    bluetoothCharacteristic.addEventListener('characteristicvaluechanged', handleBluetoothData);
                    updateBluetoothStatus('connected', `Csatlakozva: ${device.name || 'Ismeretlen eszk√∂z'}`);
                    
                    // Start reading data periodically
                    startBluetoothReading();
                } else if (bluetoothCharacteristic.properties.read) {
                    updateBluetoothStatus('connected', `Csatlakozva (polling m√≥d): ${device.name || 'Ismeretlen eszk√∂z'}`);
                    startBluetoothPolling();
                }
                
                // Show NMEA data container
                document.getElementById('nmeaContainer').style.display = 'block';
                
                // Start reconnection monitoring
                startBluetoothReconnectMonitor();
                
            } catch (error) {
                console.error('Csatlakoz√°si hiba:', error);
                updateBluetoothStatus('disconnected', `Csatlakoz√°si hiba: ${error.message}`);
            }
        }
        
        function handleBluetoothData(event) {
            const value = event.target.value;
            
            // Convert data to string
            let dataString = '';
            if (value) {
                // Try different decodings
                try {
                    dataString = new TextDecoder().decode(value);
                } catch (e) {
                    // If TextDecoder fails, try manual conversion
                    dataString = String.fromCharCode.apply(null, new Uint8Array(value.buffer));
                }
                
                processNMEAData(dataString);
            }
        }
        
        async function startBluetoothReading() {
            try {
                // Read initial value
                const value = await bluetoothCharacteristic.readValue();
                handleBluetoothData({ target: { value: value } });
            } catch (error) {
                console.log('Kezdeti olvas√°si hiba:', error);
            }
        }
        
        function startBluetoothPolling() {
            // Poll data every second if notifications not available
            setInterval(async () => {
                try {
                    if (bluetoothCharacteristic && bluetoothCharacteristic.properties.read) {
                        const value = await bluetoothCharacteristic.readValue();
                        handleBluetoothData({ target: { value: value } });
                    }
                } catch (error) {
                    console.log('Polling hiba:', error);
                }
            }, 1000);
        }
        
        function processNMEAData(dataString) {
            if (!nmeaParser) {
                nmeaParser = new NMEAParser();
            }
            
            // Split by newlines and process each line
            const lines = dataString.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                // Update NMEA display (last 5 lines)
                updateNMEADisplay(line);
                
                // Parse NMEA sentence
                const parsedData = nmeaParser.parseSentence(line);
                
                if (parsedData) {
                    // Update satellite count
                    satelliteCount = nmeaParser.getSatelliteCount();
                    updateSatelliteDisplay();
                    
                    // Process position data
                    if (parsedData.latitude && parsedData.longitude) {
                        const accuracy = parsedData.accuracy || 
                                       (parsedData.hdop ? parsedData.hdop * 5 : 50);
                        
                        // Create a mock position object similar to Geolocation API
                        const mockPosition = {
                            coords: {
                                latitude: parsedData.latitude,
                                longitude: parsedData.longitude,
                                accuracy: accuracy,
                                altitude: parsedData.altitude || null,
                                altitudeAccuracy: null,
                                heading: parsedData.course || null,
                                speed: parsedData.speed ? parsedData.speed * 0.514444 : null // knots to m/s
                            },
                            timestamp: Date.now()
                        };
                        
                        // Process position
                        processPosition(mockPosition);
                    }
                }
            }
        }
        
        function updateNMEADisplay(line) {
            const nmeaDataElement = document.getElementById('nmeaData');
            const lines = nmeaDataElement.textContent.split('\n');
            
            // Add new line at the beginning
            lines.unshift(line);
            
            // Keep only last 10 lines
            if (lines.length > 10) {
                lines.pop();
            }
            
            nmeaDataElement.textContent = lines.join('\n');
            
            // Auto-scroll to top
            nmeaDataElement.scrollTop = 0;
        }
        
        function updateSatelliteDisplay() {
            const satelliteElement = document.getElementById('satelliteCount');
            satelliteElement.textContent = satelliteCount;
            
            // Update signal bars
            const signalBars = document.querySelectorAll('.signal-bar');
            const barCount = Math.min(satelliteCount, 5);
            
            signalBars.forEach((bar, index) => {
                if (index < barCount) {
                    if (satelliteCount >= 8) {
                        bar.className = 'signal-bar active';
                    } else if (satelliteCount >= 5) {
                        bar.className = 'signal-bar medium';
                    } else {
                        bar.className = 'signal-bar weak';
                    }
                } else {
                    bar.className = 'signal-bar';
                }
            });
        }
        
        function onBluetoothDisconnected() {
            console.log('Bluetooth eszk√∂z lev√°lasztva');
            updateBluetoothStatus('disconnected', 'Bluetooth eszk√∂z lev√°lasztva');
            
            // Clear NMEA display
            document.getElementById('nmeaData').textContent = '';
            document.getElementById('nmeaContainer').style.display = 'none';
            
            // Stop reconnection monitor
            stopBluetoothReconnectMonitor();
            
            // Switch back to internal GPS if Bluetooth was active
            if (gpsSource === 'bluetooth') {
                switchToInternalGPS();
            }
        }
        
        function disconnectBluetooth() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
            
            bluetoothDevice = null;
            bluetoothCharacteristic = null;
            nmeaParser = null;
            
            updateBluetoothStatus('disconnected', 'Kapcsolat n√©lk√ºl');
            document.getElementById('nmeaContainer').style.display = 'none';
            
            stopBluetoothReconnectMonitor();
        }
        
        function updateBluetoothStatus(status, message) {
            const statusElement = document.getElementById('bluetoothStatus');
            const scanBtn = document.getElementById('bluetoothScanBtn');
            
            statusElement.textContent = `Bluetooth: ${message}`;
            statusElement.className = `bluetooth-status ${status}`;
            scanBtn.className = `bluetooth-btn ${status}`;
            
            // Update button text
            if (status === 'connected') {
                scanBtn.innerHTML = '<span class="icon">üîå</span> Kapcsolat Bont√°sa';
            } else if (status === 'scanning') {
                scanBtn.innerHTML = '<span class="icon">‚è≥</span> Keres√©s...';
            } else {
                scanBtn.innerHTML = '<span class="icon">üîç</span> Eszk√∂z√∂k Keres√©se';
            }
        }
        
        function startBluetoothReconnectMonitor() {
            // Check connection every 5 seconds
            bluetoothReconnectInterval = setInterval(() => {
                if (bluetoothDevice && !bluetoothDevice.gatt.connected && gpsSource === 'bluetooth') {
                    console.log('√öjracsatlakoz√°s k√≠s√©rlet...');
                    updateBluetoothStatus('scanning', '√öjracsatlakoz√°s...');
                    
                    connectBluetoothDevice(bluetoothDevice).catch(error => {
                        console.log('√öjracsatlakoz√°si hiba:', error);
                    });
                }
            }, 5000);
        }
        
        function stopBluetoothReconnectMonitor() {
            if (bluetoothReconnectInterval) {
                clearInterval(bluetoothReconnectInterval);
                bluetoothReconnectInterval = null;
            }
        }
        
        // ========== GPS SOURCE SWITCHING ==========
        
        function switchToInternalGPS() {
            gpsSource = 'internal';
            
            // Update UI
            document.getElementById('sourceInternal').classList.add('active');
            document.getElementById('sourceBluetooth').classList.remove('active');
            document.getElementById('bluetoothSection').style.display = 'none';
            
            // Stop Bluetooth if connected (but don't disconnect)
            console.log('√Åtv√°lt√°s bels≈ë GPS-re');
            
            // Start internal GPS tracking
            stopPositionTracking();
            setTimeout(() => {
                if (isFirefox) {
                    startFirefoxPositionTracking();
                } else {
                    startNormalPositionTracking();
                }
            }, 100);
            
            // Update GPS type badge
            document.getElementById('gpsTypeBadge').textContent = 'GPS';
            document.getElementById('gpsTypeBadge').className = 'gps-type gps-high';
            
            // Update status
            document.getElementById('locationStatus').textContent = "Bels≈ë GPS akt√≠v";
        }
        
        function switchToBluetoothGPS() {
            if (!bluetoothDevice || !bluetoothDevice.gatt.connected) {
                alert('El≈ësz√∂r csatlakozz egy Bluetooth GPS eszk√∂zh√∂z!');
                document.getElementById('sourceInternal').classList.add('active');
                document.getElementById('sourceBluetooth').classList.remove('active');
                return;
            }
            
            gpsSource = 'bluetooth';
            
            // Update UI
            document.getElementById('sourceInternal').classList.remove('active');
            document.getElementById('sourceBluetooth').classList.add('active');
            document.getElementById('bluetoothSection').style.display = 'block';
            
            // Stop internal GPS tracking
            stopPositionTracking();
            
            // Update GPS type badge
            document.getElementById('gpsTypeBadge').textContent = 'BT GPS';
            document.getElementById('gpsTypeBadge').className = 'gps-type gps-high';
            
            // Update status
            document.getElementById('locationStatus').textContent = "Bluetooth GPS akt√≠v";
        }
        
        // Modified processPosition function to handle both sources
        function processPosition(position) {
            // Only process if position is from current active source
            const newUserLatLng = [position.coords.latitude, position.coords.longitude];
            userLatLng = newUserLatLng;
            
            // Update UI
            document.getElementById('coordinates').innerHTML = 
                `<span class="highlight">${userLatLng[0].toFixed(6)}¬∞, ${userLatLng[1].toFixed(6)}¬∞</span>`;
            
            // Update accuracy
            updateAccuracyStatus(position.coords.accuracy);
            
            // Update or create marker
            if (userMarker) {
                userMarker.setLatLng(userLatLng);
            } else {
                userMarker = L.marker(userLatLng, {
                    icon: L.divIcon({
                        className: 'user-location-icon',
                        html: '<div style="background-color:#3498db;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>',
                        iconSize: [26, 26],
                        iconAnchor: [13, 13]
                    })
                }).addTo(map);
                
                userMarker.bindTooltip(`Poz√≠ci√≥ (${position.coords.accuracy.toFixed(0)}m)`, {permanent: false, direction: 'top'}).openTooltip();
            }
            
            // Update measurement if needed
            if (lastClickedElement) {
                updateMeasurement(lastClickedElement);
            }
            
            hidePositionError();
        }
        
        // ========== EXISTING CODE (from original file) ==========
        
        // T√©rk√©p inicializ√°l√°sa
        const map = L.map('map').setView([47.1625, 19.5033], 7); // Magyarorsz√°g k√∂zep√©n
        
        // OpenStreetMap alap√©rtelmezett t√©rk√©pr√©teg hozz√°ad√°sa
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // V√°ltoz√≥k inicializ√°l√°sa
        let userMarker = null;
        let userLatLng = null;
        let originalPolygons = [];
        let polygonElements = []; // √ñsszes elem: sarkok √©s oldalak
        let displayedElements = []; // Jelenleg megjelen√≠tett elemek
        let measurementLine = null; // M√©r√©si vonal
        let extendedLine = null; // Kiterjesztett egyenes
        let lastClickedElement = null;
        let currentMode = 'all'; // 'all', 'corners', 'sides'
        let isFullscreen = false;
        let sidebarVisible = true;
        let watchId = null; // Geolocation watch ID
        let forceGpsMode = false; // GPS k√©nyszer√≠t√©s m√≥d
        let isFirefox = false;
        let accuracyHistory = []; // Pontoss√°g el≈ëzm√©nyek
        
        // B√∂ng√©sz≈ë detekt√°l√°s
        function detectBrowser() {
            const userAgent = navigator.userAgent;
            
            if (userAgent.indexOf("Firefox") > -1) {
                isFirefox = true;
                document.getElementById('browserInfo').textContent = "B√∂ng√©sz≈ë: Firefox";
                document.getElementById('firefoxOptimization').style.display = 'block';
                document.getElementById('locationStatus').textContent = "Firefox √©szlelve - GPS optimaliz√°l√°s...";
            } else if (userAgent.indexOf("Chrome") > -1) {
                document.getElementById('browserInfo').textContent = "B√∂ng√©sz≈ë: Chrome";
                document.getElementById('locationStatus').textContent = "Chrome √©szlelve - Teljes GPS t√°mogat√°s";
            } else {
                document.getElementById('browserInfo').textContent = `B√∂ng√©sz≈ë: ${userAgent.split(' ')[0]}`;
            }
        }
        
        // Pontoss√°g √°llapot friss√≠t√©se
        function updateAccuracyStatus(accuracy) {
            const accuracyFill = document.getElementById('accuracyFill');
            const accuracyText = document.getElementById('accuracyText');
            const statusElement = document.querySelector('.position-status');
            const gpsTypeBadge = document.getElementById('gpsTypeBadge');
            
            // T√°roljuk a pontoss√°g el≈ëzm√©nyeket
            accuracyHistory.push(accuracy);
            if (accuracyHistory.length > 10) {
                accuracyHistory.shift();
            }
            
            // √Åtlagos pontoss√°g sz√°m√≠t√°sa
            const avgAccuracy = accuracyHistory.reduce((a, b) => a + b, 0) / accuracyHistory.length;
            
            // Pontoss√°g sz√°zal√©k (0-100%, ahol 0 a legjobb)
            let accuracyPercent;
            if (accuracy <= 10) {
                accuracyPercent = 100; // 0-10m = 100%
            } else if (accuracy <= 50) {
                accuracyPercent = 80; // 10-50m = 80%
            } else if (accuracy <= 100) {
                accuracyPercent = 60; // 50-100m = 60%
            } else if (accuracy <= 500) {
                accuracyPercent = 40; // 100-500m = 40%
            } else {
                accuracyPercent = 20; // 500m+ = 20%
            }
            
            accuracyFill.style.width = `${accuracyPercent}%`;
            accuracyText.textContent = `${accuracy.toFixed(1)} m`;
            
            // √Ållapotjelz≈ë friss√≠t√©se
            statusElement.classList.remove('high-accuracy', 'medium-accuracy', 'low-accuracy', 'inactive');
            
            if (accuracy <= 20) {
                // Magas pontoss√°g (GPS)
                statusElement.classList.add('high-accuracy');
                accuracyText.className = 'accuracy-text high-accuracy-text';
                gpsTypeBadge.textContent = 'GPS';
                gpsTypeBadge.className = 'gps-type gps-high';
                gpsTypeBadge.style.display = 'inline';
                document.getElementById('locationStatus').textContent = "Magas pontoss√°g√∫ GPS";
            } else if (accuracy <= 100) {
                // K√∂zepes pontoss√°g (WiFi/h√°l√≥zat)
                statusElement.classList.add('medium-accuracy');
                accuracyText.className = 'accuracy-text medium-accuracy-text';
                gpsTypeBadge.textContent = 'H√ÅL√ìZAT';
                gpsTypeBadge.className = 'gps-type gps-medium';
                gpsTypeBadge.style.display = 'inline';
                document.getElementById('locationStatus').textContent = "K√∂zepes pontoss√°g (h√°l√≥zat)";
            } else {
                // Alacsony pontoss√°g (cell√°s/becsl√©s)
                statusElement.classList.add('low-accuracy');
                accuracyText.className = 'accuracy-text low-accuracy-text';
                gpsTypeBadge.textContent = 'BECSL√âS';
                gpsTypeBadge.className = 'gps-type gps-low';
                gpsTypeBadge.style.display = 'inline';
                document.getElementById('locationStatus').textContent = "Alacsony pontoss√°g (becsl√©s)";
            }
            
            // Firefox specifikus javaslat
            if (isFirefox && accuracy > 50) {
                document.getElementById('firefoxOptimization').style.display = 'block';
            }
        }
        
        // Hiba√ºzenet megjelen√≠t√©se
        function showPositionError(message) {
            const errorElement = document.getElementById('positionError');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        // Hiba√ºzenet elrejt√©se
        function hidePositionError() {
            document.getElementById('positionError').style.display = 'none';
        }
        
        // Firefox GPS pontoss√°g jav√≠t√≥ megold√°s
        function startFirefoxPositionTracking() {
            console.log("Firefox GPS optimaliz√°lt k√∂vet√©s ind√≠t√°sa");
            
            // 1. PR√ìB√ÅLKOZ√ÅS: Extr√©m be√°ll√≠t√°sokkal
            try {
                watchId = navigator.geolocation.watchPosition(
                    position => {
                        processPosition(position);
                    },
                    error => {
                        handlePositionError(error);
                        // Ha az extr√©m m√≥d nem m≈±k√∂dik, pr√≥b√°ljunk norm√°l m√≥dot
                        if (isFirefox) {
                            setTimeout(startNormalPositionTracking, 1000);
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0, // ABSZOL√öT FRISS
                        timeout: 30000 // Hossz√∫ timeout Firefox-nak
                    }
                );
                
                // Extra: K√©nyszer√≠tett getCurrentPosition id≈ënk√©nt
                setInterval(() => {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            processPosition(position);
                        },
                        error => console.log("Firefox polling hiba:", error),
                        {
                            enableHighAccuracy: true,
                            maximumAge: 0,
                            timeout: 10000
                        }
                    );
                }, 2000); // 2 m√°sodpercenk√©nt
                
            } catch (error) {
                console.error("Firefox extr√©m m√≥d hiba:", error);
                startNormalPositionTracking();
            }
        }
        
        // Norm√°l poz√≠ci√≥ k√∂vet√©s
        function startNormalPositionTracking() {
            console.log("Norm√°l poz√≠ci√≥ k√∂vet√©s ind√≠t√°sa");
            
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
            }
            
            watchId = navigator.geolocation.watchPosition(
                position => {
                    processPosition(position);
                },
                handlePositionError,
                {
                    enableHighAccuracy: true,
                    maximumAge: 1000,
                    timeout: 10000
                }
            );
        }
        
        // GPS k√©nyszer√≠t√©se (agressz√≠v m√≥d)
        function forceGpsTracking() {
            console.log("GPS K√âNYSZER√çT√âS aktiv√°lva");
            forceGpsMode = true;
            
            // √Åll√≠tsuk le a kor√°bbi k√∂vet√©st
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            // K√ºl√∂nb√∂z≈ë be√°ll√≠t√°sokkal pr√≥b√°lkozunk sorban
            const gpsOptions = [
                { enableHighAccuracy: true, maximumAge: 0, timeout: 30000 }, // Extr√©m
                { enableHighAccuracy: true, maximumAge: 0, timeout: 60000 }, // M√©g extr√©mebb
                { enableHighAccuracy: false, maximumAge: 0, timeout: 30000 }, // Nem high accuracy
            ];
            
            let attempt = 0;
            
            function tryNextOption() {
                if (attempt >= gpsOptions.length) {
                    console.log("Minden GPS opci√≥ kipr√≥b√°lva, vissza norm√°l m√≥d");
                    forceGpsMode = false;
                    startNormalPositionTracking();
                    return;
                }
                
                const options = gpsOptions[attempt];
                console.log(`GPS k√©nyszer√≠t√©s pr√≥ba ${attempt + 1}:`, options);
                
                watchId = navigator.geolocation.watchPosition(
                    position => {
                        console.log(`GPS k√©nyszer√≠t√©s ${attempt + 1} sikeres, pontoss√°g: ${position.coords.accuracy}m`);
                        processPosition(position);
                    },
                    error => {
                        console.log(`GPS k√©nyszer√≠t√©s ${attempt + 1} hiba:`, error);
                        attempt++;
                        setTimeout(tryNextOption, 1000);
                    },
                    options
                );
                
                // 5 m√°sodperc m√∫lva ellen≈ërizz√ºk
                setTimeout(() => {
                    if (userLatLng === null) {
                        console.log(`GPS k√©nyszer√≠t√©s ${attempt + 1} id≈ët√∫ll√©p√©s`);
                        navigator.geolocation.clearWatch(watchId);
                        attempt++;
                        tryNextOption();
                    }
                }, 5000);
            }
            
            tryNextOption();
        }
        
        // ... (rest of existing functions remain the same, just ensure they're in the right order) ...
        
        // T√°vols√°g sz√°m√≠t√°sa k√©t pont k√∂z√∂tt (2D s√≠kban, egyszer≈±s√≠tve)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            // A F√∂ld sugara m√©terben
            const R = 6371000;
            
            // √Åtalak√≠t√°s radi√°nba
            const lat1Rad = lat1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;
            const deltaLat = (lat2 - lat1) * Math.PI / 180;
            const deltaLon = (lon2 - lon1) * Math.PI / 180;
            
            // Haversine formula
            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                      Math.cos(lat1Rad) * Math.cos(lat2Rad) *
                      Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            return distance;
        }
        
        // ... (continue with all other existing functions in their original order) ...
        
        // Event Listeners for new features
        document.getElementById('sourceInternal').addEventListener('click', switchToInternalGPS);
        document.getElementById('sourceBluetooth').addEventListener('click', switchToBluetoothGPS);
        
        document.getElementById('bluetoothScanBtn').addEventListener('click', function() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                disconnectBluetooth();
            } else {
                scanBluetoothDevices();
            }
        });
        
        // Check Bluetooth availability on load
        document.addEventListener('DOMContentLoaded', function() {
            // ... (existing initialization code) ...
            
            // Check if Bluetooth is available
            if (!navigator.bluetooth) {
                document.getElementById('sourceBluetooth').disabled = true;
                document.getElementById('sourceBluetooth').title = "A b√∂ng√©sz≈ë nem t√°mogatja a Bluetooth-ot";
                document.getElementById('bluetoothSection').innerHTML += 
                    '<div class="error-message" style="margin-top: 10px;">A b√∂ng√©sz≈ë nem t√°mogatja a Bluetooth GPS-t. Haszn√°ld a Chrome vagy Edge b√∂ng√©sz≈ët.</div>';
            }
            
            // Initialize NMEA parser
            nmeaParser = new NMEAParser();
            
            // ... (rest of existing initialization) ...
        });
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            stopPositionTracking();
            disconnectBluetooth();
        });
        
        // ... (rest of existing code remains the same) ...
    </script>
</body>
</html>
