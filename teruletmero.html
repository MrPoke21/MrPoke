<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KML Poligon Elemz≈ë √©s M√©r≈ë</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
            margin: 0;
        }
        
        .content {
            display: flex;
            flex: 1;
            padding: 0;
            gap: 0;
            overflow: hidden;
            height: calc(100vh - 60px);
        }
        
        @media (max-width: 1200px) {
            .content {
                flex-direction: column;
            }
        }
        
        .map-container {
            flex: 3;
            position: relative;
            min-height: 300px;
            height: 100%;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .sidebar {
            flex: 1.2;
            background-color: white;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-width: 350px;
            max-width: 450px;
            overflow-y: auto;
            border-left: 1px solid #ddd;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }
        
        .section-title {
            font-size: 1.4rem;
            color: #2c3e50;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #3498db;
            margin-bottom: 0.5rem;
        }
        
        .file-upload {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        
        .upload-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.9rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .upload-btn:hover {
            background-color: #2980b9;
        }
        
        .location-info, .distance-info, .element-info {
            background-color: #f8f9fa;
            padding: 1.2rem;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .element-info {
            border-left-color: #e74c3c;
        }
        
        .info-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .info-value {
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }
        
        .info-value.highlight {
            color: #e74c3c;
            font-weight: 700;
        }
        
        .instructions {
            font-size: 0.95rem;
            color: #7f8c8d;
            line-height: 1.5;
        }
        
        .icon {
            font-size: 1.2rem;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            margin-top: 0.5rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        
        .user-location {
            background-color: #3498db;
        }
        
        .polygon-corner {
            background-color: #e74c3c;
        }
        
        .polygon-side {
            background-color: #2ecc71;
            border-radius: 0;
            width: 20px;
            height: 4px;
        }
        
        .polygon-original {
            background-color: #9b59b6;
        }
        
        .selected-element {
            background-color: #f39c12;
        }
        
        .measurement-line {
            background-color: #e74c3c;
            border-radius: 0;
            width: 20px;
            height: 3px;
        }
        
        .extended-line {
            background-color: #95a5a6;
            border-radius: 0;
            width: 20px;
            height: 2px;
        }
        
        .file-name {
            font-size: 0.9rem;
            color: #7f8c8d;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            word-break: break-all;
        }
        
        .element-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .element-item {
            padding: 0.5rem;
            margin-bottom: 0.3rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .element-item:hover {
            background-color: #e9ecef;
        }
        
        .element-item.selected {
            background-color: #fff3cd;
            border-left: 3px solid #f39c12;
        }
        
        .element-type {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .element-coords {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .mode-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .mode-btn {
            flex: 1;
            padding: 0.7rem;
            border: 2px solid #ddd;
            background-color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .element-count {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 0.3rem;
        }
        
        /* Teljes k√©perny≈ës gombok */
        .fullscreen-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        .fullscreen-btn {
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #3498db;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
            color: #3498db;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .fullscreen-btn:hover {
            background-color: #3498db;
            color: white;
        }
        
        .toggle-sidebar-btn {
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #2ecc71;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
            color: #2ecc71;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .toggle-sidebar-btn:hover {
            background-color: #2ecc71;
            color: white;
        }
        
        /* Teljes k√©perny≈ës m√≥d st√≠lusok */
        body.fullscreen-mode {
            overflow: auto;
        }
        
        .fullscreen-mode .content {
            height: 100vh;
            padding: 0;
        }
        
        .fullscreen-mode .sidebar {
            display: none;
        }
        
        .fullscreen-mode .map-container {
            flex: 1;
            width: 100%;
        }
        
        .fullscreen-mode .fullscreen-controls {
            top: 20px;
            right: 20px;
        }
        
        /* Oldals√°v elrejt√©se/lenyit√°sa */
        .sidebar-hidden .sidebar {
            display: none;
        }
        
        .sidebar-hidden .map-container {
            flex: 1;
        }
        
        /* Fejl√©c (minim√°lis) */
        .mini-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }
        
        .mini-header h1 {
            font-size: 1.4rem;
            margin: 0;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .header-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }
        
        .header-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Poz√≠ci√≥ √°llapot jelz≈ëk */
        .position-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .position-status.active {
            background-color: #2ecc71;
            box-shadow: 0 0 8px #2ecc71;
        }
        
        .position-status.inactive {
            background-color: #e74c3c;
        }
        
        .position-status.waiting {
            background-color: #f39c12;
            animation: pulse 0.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Hiba√ºzenetek */
        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 5px;
            padding: 5px;
            background-color: rgba(231, 76, 60, 0.1);
            border-radius: 4px;
        }
        
        /* Friss√≠t√©si inform√°ci√≥k */
        .performance-info {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 5px;
            padding: 3px;
            background-color: #f8f9fa;
            border-radius: 3px;
        }
        
        .update-rate {
            color: #3498db;
            font-weight: 600;
        }
        
        /* Teljes√≠tm√©ny figyel√©s */
        .performance-monitor {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 0.85rem;
        }
        
        .performance-value {
            font-weight: 600;
            color: #3498db;
        }
        
        .high-performance {
            color: #2ecc71;
            font-weight: 700;
        }
        
        .low-performance {
            color: #e74c3c;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="mini-header">
        <h1>KML Poligon Elemz≈ë √©s M√©r≈ë</h1>
        <div class="header-controls">
            <button id="headerFullscreenBtn" class="header-btn">
                <span class="icon">üì∫</span>
                Teljes k√©perny≈ë
            </button>
            <button id="headerToggleSidebarBtn" class="header-btn">
                <span class="icon">‚Üî</span>
                Oldals√°v
            </button>
        </div>
    </div>
    
    <div class="content">
        <div class="map-container">
            <div id="map"></div>
            <div class="fullscreen-controls">
                <button id="fullscreenBtn" class="fullscreen-btn">
                    <span class="icon">üì∫</span>
                    Teljes k√©perny≈ë
                </button>
                <button id="toggleSidebarBtn" class="toggle-sidebar-btn">
                    <span class="icon">‚Üî</span>
                    Oldals√°v
                </button>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="control-panel">
                <h2 class="section-title">KML F√°jl Bet√∂lt√©se</h2>
                <div class="file-upload">
                    <input type="file" id="kmlFile" accept=".kml,.xml" style="display: none;">
                    <button id="uploadBtn" class="upload-btn">
                        <span class="icon">üìÅ</span>
                        KML F√°jl Kiv√°laszt√°sa
                    </button>
                    <div id="fileName" class="file-name">Nincs f√°jl kiv√°lasztva</div>
                    <p class="instructions">V√°lassz ki egy KML f√°jlt, amely poligonokat tartalmaz. A program sz√©tbontja azokat sarkokra √©s oldalakra.</p>
                </div>
                
                <div class="mode-selector">
                    <button id="modeAll" class="mode-btn active">√ñsszes elem</button>
                    <button id="modeCorners" class="mode-btn">Csak sarkok</button>
                    <button id="modeSides" class="mode-btn">Csak oldalak</button>
                </div>
                
                <h2 class="section-title">Poligon Elemek</h2>
                <div class="element-info">
                    <div class="info-title">
                        <span class="icon">üîç</span>
                        Kiv√°lasztott poligon
                    </div>
                    <div id="selectedPolygon" class="info-value">-</div>
                    <div id="elementCount" class="element-count">0 sarok, 0 oldal</div>
                    
                    <div class="info-title" style="margin-top: 1rem;">
                        <span class="icon">üìç</span>
                        Elemek list√°ja
                    </div>
                    <div id="elementsList" class="element-list">
                        <!-- Elemek list√°ja jelenik meg itt -->
                    </div>
                </div>
                
                <h2 class="section-title">Helyzet inform√°ci√≥k</h2>
                <div class="location-info">
                    <div class="info-title">
                        <span class="position-status waiting"></span>
                        <span>Jelenlegi poz√≠ci√≥</span>
                    </div>
                    <div id="locationStatus" class="info-value">MAXIMUM GYORSAS√ÅG MODE</div>
                    <div id="coordinates" class="info-value">-</div>
                    <div id="accuracyInfo" class="info-value" style="font-size: 0.9rem; color: #6c757d;">Pontoss√°g: -</div>
                    
                    <div class="performance-monitor">
                        <div class="info-title" style="font-size: 1rem;">
                            <span class="icon">‚ö°</span>
                            Teljes√≠tm√©ny monitor
                        </div>
                        <div id="updateRateInfo" class="performance-info">
                            Friss√≠t√©si r√°ta: <span class="update-rate" id="updateRate">0 Hz</span>
                        </div>
                        <div id="positionCountInfo" class="performance-info">
                            Poz√≠ci√≥ friss√≠t√©sek: <span class="performance-value" id="positionCount">0</span>
                        </div>
                        <div id="performanceStatus" class="performance-info high-performance">
                            √Ållapot: <span id="statusText">Kiv√°l√≥</span>
                        </div>
                        <div class="instructions" style="font-size: 0.8rem; margin-top: 5px;">
                            <strong>MAXIMUM GYORSAS√ÅG:</strong> Aggressz√≠v friss√≠t√©s, akkumul√°tork√≠m√©l√©s KI
                        </div>
                    </div>
                    
                    <div id="positionError" class="error-message" style="display: none;"></div>
                    <button id="resetPositionBtn" class="upload-btn" style="margin-top: 10px; padding: 0.6rem; font-size: 0.9rem; background-color: #e74c3c;">
                        <span class="icon">‚ö°</span>
                        MAXIMUM GYORSAS√ÅG √öJRAIND√çT√ÅS
                    </button>
                </div>
                
                <h2 class="section-title">T√°vols√°g m√©r√©s</h2>
                <div class="distance-info">
                    <div class="info-title">
                        <span class="icon">üìè</span>
                        Kiv√°lasztott elem
                    </div>
                    <div id="selectedElement" class="info-value">Kattints egy sarokra vagy oldalra</div>
                    <div id="distanceInfo" class="info-value">-</div>
                    <div id="nearestPointInfo" class="info-value">-</div>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color user-location"></div>
                        <span>Felhaszn√°l√≥ helye</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color polygon-corner"></div>
                        <span>Poligon sarok</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color polygon-side"></div>
                        <span>Poligon oldal</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color polygon-original"></div>
                        <span>Eredeti poligon</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color selected-element"></div>
                        <span>Kiv√°lasztott elem</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color measurement-line"></div>
                        <span>M√©r√©si vonal</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color extended-line"></div>
                        <span>Kiterjesztett egyenes</span>
                    </div>
                </div>
            </div>
            
            <div class="instructions">
                <p><strong>Haszn√°lati √∫tmutat√≥:</strong></p>
                <ul>
                    <li>T√∂lts fel egy KML f√°jlt poligonokkal</li>
                    <li>A program automatikusan sz√©tbontja a poligonokat sarkokra √©s oldalakra</li>
                    <li>V√°lassz m√≥dot: √∂sszes elem, csak sarkok vagy csak oldalak</li>
                    <li>Kattints egy sarokra vagy oldalra a t√°vols√°g m√©r√©s√©hez</li>
                    <li>Sarok eset√©n: k√∂zvetlen t√°vols√°g a sarokpontt√≥l</li>
                    <li>Vonal eset√©n: t√°vols√°g a v√©gtelenbe kiterjesztett egyenest≈ël</li>
                    <li>Piros vonal: m√©r√©si vonal a helyzeted √©s a kiv√°lasztott elem k√∂z√∂tt</li>
                    <li>Sz√ºrke vonal: a kiterjesztett egyenes (100 m√©ter mindk√©t ir√°nyba)</li>
                    <li><strong>MAXIMUM GYORSAS√ÅG:</strong> Aggressz√≠v friss√≠t√©s (ak√°r 5+ Hz)</li>
                    <li>A sz√°m√≠t√°sok 2D geometriai alap√∫ak</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // T√©rk√©p inicializ√°l√°sa
        const map = L.map('map').setView([47.1625, 19.5033], 7); // Magyarorsz√°g k√∂zep√©n
        
        // OpenStreetMap alap√©rtelmezett t√©rk√©pr√©teg hozz√°ad√°sa
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // V√°ltoz√≥k inicializ√°l√°sa
        let userMarker = null;
        let userLatLng = null;
        let originalPolygons = [];
        let polygonElements = []; // √ñsszes elem: sarkok √©s oldalak
        let displayedElements = []; // Jelenleg megjelen√≠tett elemek
        let measurementLine = null; // M√©r√©si vonal
        let extendedLine = null; // Kiterjesztett egyenes
        let lastClickedElement = null;
        let currentMode = 'all'; // 'all', 'corners', 'sides'
        let isFullscreen = false;
        let sidebarVisible = true;
        let watchId = null; // Geolocation watch ID
        let highPerformanceWatchId = null; // Aggressz√≠v watch ID
        let positionUpdateCount = 0;
        let lastPositionTime = 0;
        let positionTimes = []; // Az utols√≥ 10 friss√≠t√©s id≈ëpontjai
        let updateRate = 0;
        
        // Teljes√≠tm√©ny monitor friss√≠t√©se
        function updatePerformanceMonitor() {
            const now = Date.now();
            
            // Tartsd csak az utols√≥ 10 m√°sodperc adatait
            positionTimes = positionTimes.filter(time => now - time < 10000);
            
            // Sz√°m√≠tsd ki a friss√≠t√©si r√°ta√°t
            if (positionTimes.length > 1) {
                const timeSpan = (positionTimes[positionTimes.length - 1] - positionTimes[0]) / 1000;
                if (timeSpan > 0) {
                    updateRate = (positionTimes.length - 1) / timeSpan;
                }
            }
            
            // Friss√≠tsd a fel√ºletet
            document.getElementById('updateRate').textContent = `${updateRate.toFixed(1)} Hz`;
            document.getElementById('positionCount').textContent = positionUpdateCount;
            
            // √Ållapot √©rt√©kel√©s
            const statusElement = document.getElementById('statusText');
            const performanceElement = document.getElementById('performanceStatus');
            
            if (updateRate >= 4) {
                statusElement.textContent = "Kiv√°l√≥ (5+ Hz)";
                performanceElement.className = "performance-info high-performance";
                performanceElement.innerHTML = '√Ållapot: <span id="statusText">Kiv√°l√≥ (5+ Hz)</span>';
            } else if (updateRate >= 2) {
                statusElement.textContent = "J√≥ (2-4 Hz)";
                performanceElement.className = "performance-info";
                performanceElement.innerHTML = '√Ållapot: <span id="statusText">J√≥ (2-4 Hz)</span>';
            } else if (updateRate >= 1) {
                statusElement.textContent = "√Åtlagos (1-2 Hz)";
                performanceElement.className = "performance-info";
                performanceElement.innerHTML = '√Ållapot: <span id="statusText">√Åtlagos (1-2 Hz)</span>';
            } else {
                statusElement.textContent = "Lass√∫ (<1 Hz)";
                performanceElement.className = "performance-info low-performance";
                performanceElement.innerHTML = '√Ållapot: <span id="statusText">Lass√∫ (<1 Hz)</span>';
            }
        }
        
        // Poz√≠ci√≥ √°llapot friss√≠t√©se
        function updatePositionStatus(status) {
            const statusElement = document.querySelector('.position-status');
            statusElement.classList.remove('active', 'inactive', 'waiting');
            
            if (status === 'active') {
                statusElement.classList.add('active');
                document.getElementById('locationStatus').textContent = "MAXIMUM GYORSAS√ÅG AKT√çV";
            } else if (status === 'inactive') {
                statusElement.classList.add('inactive');
                document.getElementById('locationStatus').textContent = "MAXIMUM GYORSAS√ÅG INAKT√çV";
            } else if (status === 'waiting') {
                statusElement.classList.add('waiting');
                document.getElementById('locationStatus').textContent = "MAXIMUM GYORSAS√ÅG IND√çT√ÅS...";
            }
        }
        
        // Hiba√ºzenet megjelen√≠t√©se
        function showPositionError(message) {
            const errorElement = document.getElementById('positionError');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        // Hiba√ºzenet elrejt√©se
        function hidePositionError() {
            document.getElementById('positionError').style.display = 'none';
        }
        
        // AGGRESSZ√çV poz√≠ci√≥ k√∂vet√©s - MAXIMUM GYORSAS√ÅG
        function startAggressivePositionTracking() {
            console.log("MAXIMUM GYORSAS√ÅG poz√≠ci√≥ k√∂vet√©s ind√≠t√°sa");
            
            if (!navigator.geolocation) {
                document.getElementById('locationStatus').textContent = "B√∂ng√©sz≈ë nem t√°mogatja";
                updatePositionStatus('inactive');
                showPositionError("A b√∂ng√©sz≈ë nem t√°mogatja a helymeghat√°roz√°st");
                return;
            }
            
            updatePositionStatus('waiting');
            hidePositionError();
            
            // √Åll√≠tsuk le a kor√°bbi k√∂vet√©st, ha van
            stopPositionTracking();
            
            // Reset teljes√≠tm√©ny adatok
            positionUpdateCount = 0;
            positionTimes = [];
            updateRate = 0;
            
            // 1. PR√ìB√ÅLKOZ√ÅS: EXTREME be√°ll√≠t√°sokkal
            try {
                highPerformanceWatchId = navigator.geolocation.watchPosition(
                    position => {
                        processPosition(position);
                    },
                    error => {
                        console.warn("Extreme m√≥d hiba, v√°lt√°s agressz√≠v m√≥dra", error);
                        // Ha az extreme m√≥d nem m≈±k√∂dik, pr√≥b√°ljunk agressz√≠v m√≥dot
                        startAggressiveFallback();
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0, // ABSZOL√öT FRISS ADAT
                        timeout: 500 // Csak 500ms timeout
                    }
                );
                
                // 5 m√°sodperc m√∫lva ellen≈ërizz√ºk a teljes√≠tm√©nyt
                setTimeout(() => {
                    if (positionUpdateCount < 3) {
                        console.log("Extreme m√≥d lass√∫, v√°lt√°s agressz√≠v m√≥dra");
                        startAggressiveFallback();
                    }
                }, 5000);
                
            } catch (error) {
                console.error("Extreme m√≥d hiba:", error);
                startAggressiveFallback();
            }
        }
        
        // Agressz√≠v fallback m√≥d
        function startAggressiveFallback() {
            console.log("Agressz√≠v fallback m√≥d ind√≠t√°sa");
            
            // √Åll√≠tsuk le az extreme m√≥dot, ha fut
            if (highPerformanceWatchId !== null) {
                navigator.geolocation.clearWatch(highPerformanceWatchId);
                highPerformanceWatchId = null;
            }
            
            // Agressz√≠v watchPosition
            watchId = navigator.geolocation.watchPosition(
                position => {
                    processPosition(position);
                },
                error => {
                    handlePositionError(error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 100, // Maximum 100ms r√©gi adat
                    timeout: 1000 // 1 m√°sodperc timeout
                }
            );
            
            // EXTRA: K√©nyszer√≠tett pollol√°s is, hogy biztosan kapjunk friss√≠t√©st
            const forcedPoll = setInterval(() => {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        processPosition(position);
                    },
                    error => {
                        // Csak napl√≥zzuk, ne √°ll√≠tsuk le a pollol√°st
                        console.log("Polling hiba:", error);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 2000
                    }
                );
            }, 200); // M√âG AGGESSZ√çVABB: 200ms (5Hz)
            
            // Tiszt√≠t√°s a k√∂vetkez≈ë ind√≠t√°skor
            window.forcedPollInterval = forcedPoll;
        }
        
        // Poz√≠ci√≥ feldolgoz√°sa
        function processPosition(position) {
            updatePositionStatus('active');
            positionUpdateCount++;
            
            const now = Date.now();
            lastPositionTime = now;
            positionTimes.push(now);
            
            // T√∫l r√©gi id≈ëpontok elt√°vol√≠t√°sa
            if (positionTimes.length > 100) {
                positionTimes = positionTimes.slice(-100);
            }
            
            const newUserLatLng = [position.coords.latitude, position.coords.longitude];
            userLatLng = newUserLatLng;
            
            // Friss√≠tsd a felhaszn√°l√≥ helyzet√©t a fel√ºleten
            document.getElementById('coordinates').innerHTML = 
                `<span class="highlight">${userLatLng[0].toFixed(6)}¬∞, ${userLatLng[1].toFixed(6)}¬∞</span>`;
            
            // Pontoss√°g inform√°ci√≥
            const accuracy = position.coords.accuracy;
            document.getElementById('accuracyInfo').textContent = 
                `Pontoss√°g: ${accuracy ? accuracy.toFixed(1) + ' m' : 'ismeretlen'}`;
            
            // Ha m√°r van jel√∂l≈ë, mozgasd, k√ºl√∂nben hozz l√©tre √∫jat
            if (userMarker) {
                userMarker.setLatLng(userLatLng);
            } else {
                userMarker = L.marker(userLatLng, {
                    icon: L.divIcon({
                        className: 'user-location-icon',
                        html: '<div style="background-color:#3498db;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>',
                        iconSize: [26, 26],
                        iconAnchor: [13, 13]
                    })
                }).addTo(map);
                
                // Adj tooltip-et a jel√∂l≈ëh√∂z
                userMarker.bindTooltip("A te helyzeted (REALTIME)", {permanent: false, direction: 'top'}).openTooltip();
            }
            
            // Mindig friss√≠tsd a m√©r√©st, ha van kiv√°lasztott elem
            if (lastClickedElement) {
                updateMeasurement(lastClickedElement);
            }
            
            hidePositionError();
            
            // Teljes√≠tm√©ny monitor friss√≠t√©se
            updatePerformanceMonitor();
        }
        
        // Poz√≠ci√≥ hiba kezel√©se
        function handlePositionError(error) {
            console.error("Helymeghat√°roz√°si hiba:", error);
            updatePositionStatus('inactive');
            
            let errorMessage = "HIBA: ";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += "Hozz√°f√©r√©s megtagadva. Enged√©lyezd a helymeghat√°roz√°st!";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += "GPS nem el√©rhet≈ë. Kapcsold be a GPS-t!";
                    break;
                case error.TIMEOUT:
                    errorMessage += "Id≈ët√∫ll√©p√©s. Pr√≥b√°ld √∫jra!";
                    break;
                default:
                    errorMessage += "Ismeretlen hiba.";
                    break;
            }
            
            document.getElementById('locationStatus').textContent = "HIBA";
            document.getElementById('coordinates').textContent = "-";
            document.getElementById('accuracyInfo').textContent = "Pontoss√°g: -";
            
            showPositionError(errorMessage);
            
            // Alap√©rtelmezett poz√≠ci√≥ (Budapest) be√°ll√≠t√°sa hiba eset√©n
            if (!userLatLng) {
                userLatLng = [47.4979, 19.0402];
                userMarker = L.marker(userLatLng, {
                    icon: L.divIcon({
                        className: 'user-location-icon',
                        html: '<div style="background-color:#3498db;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>',
                        iconSize: [26, 26],
                        iconAnchor: [13, 13]
                    })
                }).addTo(map);
                userMarker.bindTooltip("A te helyzeted (ALAP√âRTELMEZETT)", {permanent: false, direction: 'top'}).openTooltip();
            }
        }
        
        // Poz√≠ci√≥ k√∂vet√©s le√°ll√≠t√°sa
        function stopPositionTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            if (highPerformanceWatchId !== null) {
                navigator.geolocation.clearWatch(highPerformanceWatchId);
                highPerformanceWatchId = null;
            }
            
            if (window.forcedPollInterval) {
                clearInterval(window.forcedPollInterval);
                window.forcedPollInterval = null;
            }
            
            positionUpdateCount = 0;
            updatePositionStatus('inactive');
        }
        
        // Teljes k√©perny≈ës funkci√≥k
        function toggleFullscreen() {
            const body = document.body;
            const container = document.querySelector('.container');
            
            if (!isFullscreen) {
                // Bel√©p√©s teljes k√©perny≈ës m√≥dba
                body.classList.add('fullscreen-mode');
                isFullscreen = true;
                
                // Friss√≠tsd a gomb sz√∂veg√©t
                document.getElementById('fullscreenBtn').innerHTML = '<span class="icon">üì±</span> Kil√©p√©s';
                document.getElementById('headerFullscreenBtn').innerHTML = '<span class="icon">üì±</span> Kil√©p√©s';
                
                // Rejtsd el a mini fejl√©cet teljes k√©perny≈ës m√≥dban
                document.querySelector('.mini-header').style.display = 'none';
            } else {
                // Kil√©p√©s teljes k√©perny≈ës m√≥db√≥l
                body.classList.remove('fullscreen-mode');
                isFullscreen = false;
                
                // Friss√≠tsd a gomb sz√∂veg√©t
                document.getElementById('fullscreenBtn').innerHTML = '<span class="icon">üì∫</span> Teljes k√©perny≈ë';
                document.getElementById('headerFullscreenBtn').innerHTML = '<span class="icon">üì∫</span> Teljes k√©perny≈ë';
                
                // Jelen√≠tsd meg √∫jra a mini fejl√©cet
                document.querySelector('.mini-header').style.display = 'flex';
            }
            
            // Friss√≠tsd a t√©rk√©p m√©ret√©t
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }
        
        // Oldals√°v v√°lt√°sa
        function toggleSidebar() {
            const body = document.body;
            
            if (sidebarVisible) {
                // Rejtsd el az oldals√°vot
                body.classList.add('sidebar-hidden');
                sidebarVisible = false;
                
                // Friss√≠tsd a gomb sz√∂veg√©t
                document.getElementById('toggleSidebarBtn').innerHTML = '<span class="icon">‚Üî</span> Oldals√°v';
                document.getElementById('headerToggleSidebarBtn').innerHTML = '<span class="icon">‚Üî</span> Oldals√°v';
            } else {
                // Jelen√≠tsd meg az oldals√°vot
                body.classList.remove('sidebar-hidden');
                sidebarVisible = true;
                
                // Friss√≠tsd a gomb sz√∂veg√©t
                document.getElementById('toggleSidebarBtn').innerHTML = '<span class="icon">‚Üî</span> Rejtsd el';
                document.getElementById('headerToggleSidebarBtn').innerHTML = '<span class="icon">‚Üî</span> Rejtsd el';
            }
            
            // Friss√≠tsd a t√©rk√©p m√©ret√©t
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }
        
        // T√°vols√°g sz√°m√≠t√°sa k√©t pont k√∂z√∂tt (2D s√≠kban, egyszer≈±s√≠tve)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            // A F√∂ld sugara m√©terben
            const R = 6371000;
            
            // √Åtalak√≠t√°s radi√°nba
            const lat1Rad = lat1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;
            const deltaLat = (lat2 - lat1) * Math.PI / 180;
            const deltaLon = (lon2 - lon1) * Math.PI / 180;
            
            // Haversine formula
            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                      Math.cos(lat1Rad) * Math.cos(lat2Rad) *
                      Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            return distance;
        }
        
        // Pont √©s v√©gtelen egyenes t√°vols√°ga (legk√∂zelebbi pont az egyenesen)
        function pointToInfiniteLineDistance(point, lineStart, lineEnd) {
            // Vektorok sz√°m√≠t√°sa
            const lineVec = {
                x: lineEnd.lng - lineStart.lng,
                y: lineEnd.lat - lineStart.lat
            };
            
            const pointVec = {
                x: point.lng - lineStart.lng,
                y: point.lat - lineStart.lat
            };
            
            // Vonal hossza
            const lineLengthSq = lineVec.x * lineVec.x + lineVec.y * lineVec.y;
            
            // Skal√°ris szorzat
            const dot = pointVec.x * lineVec.x + pointVec.y * lineVec.y;
            
            // Param√©ter a v√©gtelen egyenesen (t negat√≠v vagy nagyobb mint 1 is lehet)
            const t = lineLengthSq !== 0 ? dot / lineLengthSq : 0;
            
            // Legk√∂zelebbi pont a v√©gtelen egyenesen
            const closestLng = lineStart.lng + t * lineVec.x;
            const closestLat = lineStart.lat + t * lineVec.y;
            
            // T√°vols√°g sz√°m√≠t√°sa
            const distance = calculateDistance(point.lat, point.lng, closestLat, closestLng);
            
            return {
                distance: distance,
                closestPoint: {lat: closestLat, lng: closestLng},
                t: t  // param√©ter a meghosszabb√≠t√°shoz
            };
        }
        
        // Egyenes meghosszabb√≠t√°sa mindk√©t ir√°nyba
        function extendLine(lineStart, lineEnd, extensionMeters = 100) {
            // Ir√°nyvektor sz√°m√≠t√°sa
            const dx = lineEnd.lng - lineStart.lng;
            const dy = lineEnd.lat - lineStart.lat;
            
            // Vektor hossza (fokban)
            const length = Math.sqrt(dx * dx + dy * dy);
            
            if (length === 0) return {start: lineStart, end: lineEnd};
            
            // M√©terek √°tv√°lt√°sa fokokba (k√∂zel√≠t√©s: 1 fok ~ 111 km)
            const extensionDegrees = extensionMeters / 111000;
            
            // Normaliz√°lt ir√°nyvektor
            const normDx = dx / length;
            const normDy = dy / length;
            
            // Meghosszabb√≠tott pontok
            const extendedStart = {
                lat: lineStart.lat - normDy * extensionDegrees,
                lng: lineStart.lng - normDx * extensionDegrees
            };
            
            const extendedEnd = {
                lat: lineEnd.lat + normDy * extensionDegrees,
                lng: lineEnd.lng + normDx * extensionDegrees
            };
            
            return {start: extendedStart, end: extendedEnd};
        }
        
        // M√©r√©si vonal rajzol√°sa
        function drawMeasurementLine(startLatLng, endLatLng) {
            // T√°vol√≠tsd el a kor√°bbi m√©r√©si vonalat, ha van
            if (measurementLine) {
                map.removeLayer(measurementLine);
            }
            
            // Hozz l√©tre √∫j m√©r√©si vonalat
            measurementLine = L.polyline([startLatLng, endLatLng], {
                color: '#e74c3c',
                weight: 3,
                opacity: 0.9,
                dashArray: '10, 10'
            }).addTo(map);
            
            // Adj tooltip-et a vonalhoz a t√°vols√°ggal
            const distance = calculateDistance(startLatLng[0], startLatLng[1], endLatLng[0], endLatLng[1]);
            measurementLine.bindTooltip(`${distance.toFixed(2)} m`, {permanent: true, direction: 'top'});
        }
        
        // Kiterjesztett egyenes rajzol√°sa
        function drawExtendedLine(lineStart, lineEnd) {
            // T√°vol√≠tsd el a kor√°bbi kiterjesztett vonalat, ha van
            if (extendedLine) {
                map.removeLayer(extendedLine);
            }
            
            // Egyenes meghosszabb√≠t√°sa 100 m√©terrel mindk√©t ir√°nyba
            const extended = extendLine(lineStart, lineEnd, 100);
            
            // Hozz l√©tre a kiterjesztett vonalat
            extendedLine = L.polyline([
                [extended.start.lat, extended.start.lng],
                [extended.end.lat, extended.end.lng]
            ], {
                color: '#95a5a6',
                weight: 2,
                opacity: 0.5,
                dashArray: '5, 10'
            }).addTo(map);
            
            extendedLine.bindTooltip("Kiterjesztett egyenes (100m)", {permanent: false, direction: 'top'});
        }
        
        // Poligon sz√©tbont√°sa sarkokra √©s oldalakra
        function decomposePolygon(polygon, polygonName, polygonIndex) {
            const latLngs = polygon.getLatLngs()[0]; // K√ºls≈ë keret
            const elements = [];
            
            // Sarkok l√©trehoz√°sa
            for (let i = 0; i < latLngs.length; i++) {
                const corner = latLngs[i];
                const cornerIndex = i;
                const cornerId = `polygon_${polygonIndex}_corner_${cornerIndex}`;
                
                // Sarok marker l√©trehoz√°sa
                const cornerMarker = L.marker([corner.lat, corner.lng], {
                    icon: L.divIcon({
                        className: 'polygon-corner-icon',
                        html: '<div style="background-color:#e74c3c;width:16px;height:16px;border-radius:50%;border:2px solid white;box-shadow:0 0 8px rgba(0,0,0,0.3);"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                
                cornerMarker.bindTooltip(`Sarok ${cornerIndex+1}: ${polygonName}`, {permanent: false, direction: 'top'});
                
                // Esem√©nykezel≈ë hozz√°ad√°sa
                cornerMarker.on('click', function(e) {
                    handleElementClick(cornerMarker, {
                        id: cornerId,
                        type: 'corner',
                        polygonName: polygonName,
                        polygonIndex: polygonIndex,
                        cornerIndex: cornerIndex,
                        latlng: corner
                    });
                });
                
                elements.push({
                    id: cornerId,
                    type: 'corner',
                    layer: cornerMarker,
                    polygonName: polygonName,
                    polygonIndex: polygonIndex,
                    cornerIndex: cornerIndex,
                    latlng: corner,
                    name: `Sarok ${cornerIndex+1}`,
                    coords: `${corner.lat.toFixed(5)}¬∞, ${corner.lng.toFixed(5)}¬∞`
                });
            }
            
            // Oldalak l√©trehoz√°sa
            for (let i = 0; i < latLngs.length; i++) {
                const nextIndex = (i + 1) % latLngs.length;
                const start = latLngs[i];
                const end = latLngs[nextIndex];
                const sideIndex = i;
                const sideId = `polygon_${polygonIndex}_side_${sideIndex}`;
                
                // Oldal vonal l√©trehoz√°sa
                const sideLine = L.polyline([[start.lat, start.lng], [end.lat, end.lng]], {
                    color: '#2ecc71',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '5, 5'
                }).addTo(map);
                
                sideLine.bindTooltip(`Oldal ${sideIndex+1}: ${polygonName}`, {permanent: false, direction: 'top'});
                
                // Esem√©nykezel≈ë hozz√°ad√°sa
                sideLine.on('click', function(e) {
                    handleElementClick(sideLine, {
                        id: sideId,
                        type: 'side',
                        polygonName: polygonName,
                        polygonIndex: polygonIndex,
                        sideIndex: sideIndex,
                        startPoint: start,
                        endPoint: end,
                        latlng: e.latlng
                    });
                });
                
                elements.push({
                    id: sideId,
                    type: 'side',
                    layer: sideLine,
                    polygonName: polygonName,
                    polygonIndex: polygonIndex,
                    sideIndex: sideIndex,
                    startPoint: start,
                    endPoint: end,
                    name: `Oldal ${sideIndex+1}`,
                    coords: `${start.lat.toFixed(5)}¬∞‚Üí${end.lat.toFixed(5)}¬∞`
                });
            }
            
            return elements;
        }
        
        // Elemre kattint√°s kezel√©se
        function handleElementClick(layer, elementData) {
            if (!userLatLng) {
                alert("El≈ësz√∂r enged√©lyezd a helymeghat√°roz√°s√°t!");
                return;
            }
            
            // Jel√∂ld meg az utolj√°ra kattintott elemet
            if (lastClickedElement) {
                resetElementStyle(lastClickedElement);
            }
            
            // Kiemeld a kiv√°lasztott elemet
            highlightElement(layer, elementData.type);
            lastClickedElement = {layer: layer, type: elementData.type, data: elementData};
            
            // Friss√≠tsd a m√©r√©st
            updateMeasurement(lastClickedElement);
            
            // Friss√≠tsd az elemek list√°j√°ban a kiv√°lasztott elemet
            updateElementsListSelection(elementData.id);
        }
        
        // M√©r√©s friss√≠t√©se
        function updateMeasurement(element) {
            if (!element || !element.data || !userLatLng) return;
            
            const elementData = element.data;
            
            // Friss√≠tsd a kiv√°lasztott poligon inform√°ci√≥it
            document.getElementById('selectedPolygon').innerHTML = 
                `<span class="highlight">${elementData.polygonName}</span>`;
            
            let targetPoint = null;
            let distance = 0;
            let elementTypeText = '';
            
            // T√°vol√≠tsd el a kor√°bbi kiterjesztett vonalat
            if (extendedLine) {
                map.removeLayer(extendedLine);
                extendedLine = null;
            }
            
            if (elementData.type === 'corner') {
                // Sarok eset√©n a sarok pontja a c√©lpont
                targetPoint = elementData.latlng;
                elementTypeText = `Sarok ${elementData.cornerIndex + 1}`;
                distance = calculateDistance(userLatLng[0], userLatLng[1], targetPoint.lat, targetPoint.lng);
                
                document.getElementById('selectedElement').innerHTML = 
                    `<span class="highlight">${elementTypeText}</span>`;
                document.getElementById('nearestPointInfo').innerHTML = 
                    `Pont: ${targetPoint.lat.toFixed(6)}¬∞, ${targetPoint.lng.toFixed(6)}¬∞`;
                
            } else if (elementData.type === 'side') {
                // Oldal eset√©n sz√°m√≠tsuk ki a legk√∂zelebbi pontot a v√©gtelen egyenesen
                const userPoint = {lat: userLatLng[0], lng: userLatLng[1]};
                const lineResult = pointToInfiniteLineDistance(userPoint, elementData.startPoint, elementData.endPoint);
                
                distance = lineResult.distance;
                targetPoint = lineResult.closestPoint;
                elementTypeText = `Oldal ${elementData.sideIndex + 1}`;
                
                document.getElementById('selectedElement').innerHTML = 
                    `<span class="highlight">${elementTypeText}</span>`;
                document.getElementById('nearestPointInfo').innerHTML = 
                    `Legk√∂zelebbi pont a v√©gtelen egyenesen: ${targetPoint.lat.toFixed(6)}¬∞, ${targetPoint.lng.toFixed(6)}¬∞`;
                
                // Rajzold ki a kiterjesztett egyenest
                drawExtendedLine(elementData.startPoint, elementData.endPoint);
            }
            
            // T√°vols√°g megjelen√≠t√©se cm-ben √©s m√©terben
            const distanceCm = distance * 100;
            document.getElementById('distanceInfo').innerHTML = 
                `<span class="highlight">${distanceCm.toFixed(2)} cm</span> (${distance.toFixed(2)} m)`;
            
            // Rajzold ki a m√©r√©si vonalat
            if (targetPoint) {
                drawMeasurementLine(userLatLng, [targetPoint.lat, targetPoint.lng]);
            }
        }
        
        // Elem st√≠lus√°nak vissza√°ll√≠t√°sa
        function resetElementStyle(element) {
            if (!element || !element.layer) return;
            
            if (element.type === 'corner') {
                element.layer.setIcon(L.divIcon({
                    className: 'polygon-corner-icon',
                    html: '<div style="background-color:#e74c3c;width:16px;height:16px;border-radius:50%;border:2px solid white;box-shadow:0 0 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                }));
            } else if (element.type === 'side') {
                element.layer.setStyle({
                    color: '#2ecc71',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '5, 5'
                });
            }
        }
        
        // Elem kiemel√©se
        function highlightElement(layer, type) {
            if (type === 'corner') {
                layer.setIcon(L.divIcon({
                    className: 'polygon-corner-icon',
                    html: '<div style="background-color:#f39c12;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.5);"></div>',
                    iconSize: [26, 26],
                    iconAnchor: [13, 13]
                }));
            } else if (type === 'side') {
                layer.setStyle({
                    color: '#f39c12',
                    weight: 6,
                    opacity: 1,
                    dashArray: null
                });
            }
        }
        
        // Egyszer≈±s√≠tett KML parser - csak poligonokra f√≥kusz√°lva
        function parseKML(kmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(kmlText, "text/xml");
            
            // T√°vol√≠tsd el a kor√°bbi r√©tegeket
            clearAllLayers();
            
            // Placemarks keres√©se
            const placemarks = xmlDoc.getElementsByTagName('Placemark');
            polygonElements = [];
            
            for (let i = 0; i < placemarks.length; i++) {
                const placemark = placemarks[i];
                
                // N√©v lek√©r√©se
                const nameElement = placemark.getElementsByTagName('name')[0];
                const name = nameElement ? nameElement.textContent : `Poligon ${i+1}`;
                
                // Soksz√∂gek (Polygon) keres√©se
                const polygons = placemark.getElementsByTagName('Polygon');
                for (let j = 0; j < polygons.length; j++) {
                    const polygon = polygons[j];
                    const outerBoundary = polygon.getElementsByTagName('outerBoundaryIs')[0];
                    
                    if (outerBoundary) {
                        const coordinates = outerBoundary.getElementsByTagName('coordinates')[0];
                        if (coordinates) {
                            const coordsArray = coordinates.textContent.trim().split(/\s+/);
                            const latLngs = [];
                            
                            for (let coord of coordsArray) {
                                const [lng, lat] = coord.split(',').map(Number);
                                if (!isNaN(lat) && !isNaN(lng)) {
                                    latLngs.push([lat, lng]);
                                }
                            }
                            
                            if (latLngs.length > 2) {
                                // Eredeti poligon l√©trehoz√°sa (√°tl√°tsz√≥, csak kont√∫r)
                                const polygonLayer = L.polygon(latLngs, {
                                    color: '#9b59b6',
                                    weight: 2,
                                    opacity: 0.7,
                                    fillOpacity: 0.1
                                }).addTo(map);
                                
                                polygonLayer.bindTooltip(name, {permanent: false, direction: 'top'});
                                originalPolygons.push(polygonLayer);
                                
                                // Poligon sz√©tbont√°sa sarkokra √©s oldalakra
                                const polygonName = `${name} (${latLngs.length} oldal√∫)`;
                                const elements = decomposePolygon(polygonLayer, polygonName, i);
                                polygonElements = polygonElements.concat(elements);
                            }
                        }
                    }
                }
            }
            
            // Elemek list√°j√°nak friss√≠t√©se
            updateElementsList();
            
            // Alap√©rtelmezett m√≥d: √∂sszes elem
            filterElementsByMode('all');
            
            // Zoomol√°s az √∂sszes poligonra
            if (originalPolygons.length > 0) {
                const group = L.featureGroup(originalPolygons);
                map.fitBounds(group.getBounds().pad(0.1));
            }
            
            // Friss√≠tsd az elemek sz√°m√°t
            updateElementCount();
        }
        
        // √ñsszes r√©teg t√∂rl√©se
        function clearAllLayers() {
            // Eredeti poligonok t√∂rl√©se
            originalPolygons.forEach(layer => {
                map.removeLayer(layer);
            });
            originalPolygons = [];
            
            // Poligon elemek t√∂rl√©se
            polygonElements.forEach(element => {
                map.removeLayer(element.layer);
            });
            polygonElements = [];
            
            // Megjelen√≠tett elemek t√∂rl√©se
            displayedElements = [];
            
            // M√©r√©si vonal t√∂rl√©se
            if (measurementLine) {
                map.removeLayer(measurementLine);
                measurementLine = null;
            }
            
            // Kiterjesztett vonal t√∂rl√©se
            if (extendedLine) {
                map.removeLayer(extendedLine);
                extendedLine = null;
            }
            
            // Kiv√°lasztott elem vissza√°ll√≠t√°sa
            lastClickedElement = null;
        }
        
        // Elemek list√°j√°nak friss√≠t√©se
        function updateElementsList() {
            const elementsList = document.getElementById('elementsList');
            elementsList.innerHTML = '';
            
            polygonElements.forEach(element => {
                const elementDiv = document.createElement('div');
                elementDiv.className = 'element-item';
                elementDiv.id = `list_${element.id}`;
                elementDiv.innerHTML = `
                    <div class="element-type">${element.name} (${element.type === 'corner' ? 'Sarok' : 'Oldal'})</div>
                    <div class="element-coords">${element.coords}</div>
                `;
                
                elementDiv.addEventListener('click', () => {
                    // Kattints a t√©rk√©pen l√©v≈ë elemre
                    if (element.layer && element.layer.fire) {
                        const latlng = element.type === 'corner' ? element.latlng : 
                                     {lat: (element.startPoint.lat + element.endPoint.lat)/2, 
                                      lng: (element.startPoint.lng + element.endPoint.lng)/2};
                        element.layer.fire('click', {latlng: latlng});
                    }
                });
                
                elementsList.appendChild(elementDiv);
            });
        }
        
        // Elemek list√°j√°ban a kiv√°lasztott elem friss√≠t√©se
        function updateElementsListSelection(elementId) {
            // El≈ëz≈ë kiv√°lasztott elem elt√°vol√≠t√°sa
            const prevSelected = document.querySelector('.element-item.selected');
            if (prevSelected) {
                prevSelected.classList.remove('selected');
            }
            
            // √öj elem kijel√∂l√©se
            const elementDiv = document.getElementById(`list_${elementId}`);
            if (elementDiv) {
                elementDiv.classList.add('selected');
                elementDiv.scrollIntoView({behavior: 'smooth', block: 'nearest'});
            }
        }
        
        // Elemek sz≈±r√©se m√≥d szerint
        function filterElementsByMode(mode) {
            currentMode = mode;
            
            // El≈ëz≈ëleg megjelen√≠tett elemek elrejt√©se
            displayedElements.forEach(element => {
                map.removeLayer(element.layer);
            });
            
            // √öj elemek kiv√°laszt√°sa a m√≥d alapj√°n
            if (mode === 'all') {
                displayedElements = [...polygonElements];
            } else if (mode === 'corners') {
                displayedElements = polygonElements.filter(e => e.type === 'corner');
            } else if (mode === 'sides') {
                displayedElements = polygonElements.filter(e => e.type === 'side');
            }
            
            // √öj elemek megjelen√≠t√©se
            displayedElements.forEach(element => {
                map.addLayer(element.layer);
            });
            
            // M√≥d gombok friss√≠t√©se
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
            
            // Elemek sz√°m√°nak friss√≠t√©se
            updateElementCount();
        }
        
        // Elemek sz√°m√°nak friss√≠t√©se
        function updateElementCount() {
            const corners = polygonElements.filter(e => e.type === 'corner').length;
            const sides = polygonElements.filter(e => e.type === 'side').length;
            document.getElementById('elementCount').textContent = `${corners} sarok, ${sides} oldal`;
        }
        
        // KML f√°jl bet√∂lt√©se
        function loadKMLFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const kmlText = e.target.result;
                    parseKML(kmlText);
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('fileName').style.color = '#27ae60';
                } catch (error) {
                    console.error("Hiba a KML feldolgoz√°s√°ban:", error);
                    alert("Hiba a KML f√°jl feldolgoz√°s√°ban. Ellen≈ërizd, hogy √©rv√©nyes KML f√°jlt t√∂lt√∂tt√©l-e fel.");
                }
            };
            
            reader.onerror = function() {
                alert("Hiba a f√°jl olvas√°s√°ban.");
            };
            
            reader.readAsText(file);
        }
        
        // Esem√©nykezel≈ëk be√°ll√≠t√°sa
        document.getElementById('uploadBtn').addEventListener('click', function() {
            document.getElementById('kmlFile').click();
        });
        
        document.getElementById('kmlFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.name.toLowerCase().endsWith('.kml') || file.name.toLowerCase().endsWith('.xml')) {
                    loadKMLFile(file);
                    document.getElementById('uploadBtn').innerHTML = `<span class="icon">‚úÖ</span> F√°jl bet√∂ltve`;
                } else {
                    alert("K√©rlek, csak KML vagy XML f√°jlokat t√∂lts fel!");
                    document.getElementById('kmlFile').value = '';
                    document.getElementById('fileName').textContent = "√ârv√©nytelen f√°jlt√≠pus";
                    document.getElementById('fileName').style.color = '#e74c3c';
                }
            }
        });
        
        // M√≥dv√°laszt√≥ gombok esem√©nykezel≈ëi
        document.getElementById('modeAll').addEventListener('click', () => filterElementsByMode('all'));
        document.getElementById('modeCorners').addEventListener('click', () => filterElementsByMode('corners'));
        document.getElementById('modeSides').addEventListener('click', () => filterElementsByMode('sides'));
        
        // Teljes k√©perny≈ës gombok
        document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
        document.getElementById('headerFullscreenBtn').addEventListener('click', toggleFullscreen);
        
        // Oldals√°v v√°lt√≥ gombok
        document.getElementById('toggleSidebarBtn').addEventListener('click', toggleSidebar);
        document.getElementById('headerToggleSidebarBtn').addEventListener('click', toggleSidebar);
        
        // Poz√≠ci√≥ friss√≠t√©s gomb
        document.getElementById('resetPositionBtn').addEventListener('click', function() {
            console.log("MAXIMUM GYORSAS√ÅG √öJRAIND√çT√ÅS");
            stopPositionTracking();
            setTimeout(() => {
                startAggressivePositionTracking();
            }, 100);
        });
        
        // Inicializ√°l√°s
        document.addEventListener('DOMContentLoaded', function() {
            // Ind√≠tsd el az AGGRESSZ√çV helymeghat√°roz√°st
            startAggressivePositionTracking();
            
            // Minta poligon bet√∂lt√©se a bemutat√≥hoz
            setTimeout(() => {
                // Minta poligon l√©trehoz√°sa (n√©gyzet)
                const samplePolygon = L.polygon([
                    [47.5000, 19.0300],
                    [47.5100, 19.0300],
                    [47.5100, 19.0400],
                    [47.5000, 19.0400]
                ], {
                    color: '#9b59b6',
                    weight: 2,
                    opacity: 0.7,
                    fillOpacity: 0.1
                }).addTo(map);
                
                originalPolygons.push(samplePolygon);
                samplePolygon.bindTooltip("Minta poligon (n√©gyzet)", {permanent: false, direction: 'top'});
                
                // Poligon sz√©tbont√°sa sarkokra √©s oldalakra
                const elements = decomposePolygon(samplePolygon, "Minta poligon (n√©gyzet)", 0);
                polygonElements = polygonElements.concat(elements);
                
                // Elemek list√°j√°nak friss√≠t√©se
                updateElementsList();
                
                // Alap√©rtelmezett m√≥d: √∂sszes elem
                filterElementsByMode('all');
                
                document.getElementById('fileName').textContent = "Bemutat√≥ n√©gyzet poligon";
                document.getElementById('fileName').style.color = '#3498db';
                
                // K√∂zel√≠t√©s a poligonhoz
                map.fitBounds(samplePolygon.getBounds().pad(0.2));
            }, 1000);
            
            // Teljes√≠tm√©ny monitor periodikus friss√≠t√©se
            setInterval(updatePerformanceMonitor, 1000);
        });
        
        // Az oldal bez√°r√°sakor √°ll√≠tsd le a poz√≠ci√≥ k√∂vet√©st
        window.addEventListener('beforeunload', function() {
            stopPositionTracking();
        });
        
        // Billenty≈±zet parancsok
        document.addEventListener('keydown', function(e) {
            // F11 teljes k√©perny≈ë (de megakad√°lyozzuk az alap√©rtelmezett viselked√©st)
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
            // ESC kil√©p√©s teljes k√©perny≈ëb≈ël
            if (e.key === 'Escape' && isFullscreen) {
                toggleFullscreen();
            }
            // Space oldals√°v v√°lt√°sa
            if (e.key === ' ') {
                e.preventDefault();
                toggleSidebar();
            }
            // R billenty≈± a poz√≠ci√≥ √∫jraind√≠t√°s√°hoz
            if (e.key === 'r' || e.key === 'R') {
                e.preventDefault();
                console.log("R billenty≈± - MAXIMUM GYORSAS√ÅG √öJRAIND√çT√ÅS");
                stopPositionTracking();
                setTimeout(() => {
                    startAggressivePositionTracking();
                }, 100);
            }
        });
        
        // Oldal l√°that√≥s√°g v√°ltoz√°sakor is friss√≠ts√ºk a poz√≠ci√≥t
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Ha az oldal √∫jra l√°that√≥v√° v√°lik, ind√≠tsuk √∫jra a k√∂vet√©st
                setTimeout(() => {
                    console.log("Oldal l√°that√≥ - MAXIMUM GYORSAS√ÅG √öJRAIND√çT√ÅS");
                    stopPositionTracking();
                    setTimeout(() => {
                        startAggressivePositionTracking();
                    }, 100);
                }, 500);
            }
        });
    </script>
</body>
</html>
